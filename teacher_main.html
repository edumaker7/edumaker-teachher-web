<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë“€ë©”ì´ì»¤ - ê°•ì‚¬ ì „ìš©</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; margin: 0; padding: 0; }
        .header { background-color: #0056b3; color: white; padding: 20px; text-align: center; }
        .container { max-width: 900px; margin: 20px auto; padding: 0 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .welcome-msg { font-size: 16px; color: #333; margin: 0; font-weight: 600; }
        .view-toggle { display: flex; background: #e9ecef; border-radius: 8px; padding: 4px; }
        .toggle-btn { border: none; background: none; padding: 8px 12px; font-size: 13px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #666; }
        .toggle-btn.active { background: #fff; color: #0056b3; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .assignment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        /* ì¹´ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼: ìƒë‹¨ í…Œë‘ë¦¬ëŠ” ì¸ë¼ì¸ìœ¼ë¡œ ë™ì  ì²˜ë¦¬ */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
        .card h3 { margin-top: 0; color: #0056b3; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; align-items: center; }
        .card h3::before { content: 'ğŸ« '; }
        
        .info-single { margin-bottom: 8px; }
        .info-single p { margin: 0 !important; font-size: 13.5px; color: #555; display: flex; align-items: flex-start; line-height: 1.6; flex-wrap: wrap; }
        .info-single b { color: #333; width: 85px; flex-shrink: 0; display: inline-block; }
        .info-single span { flex: 1; word-break: break-all; display: inline; }

        .detail-section { display: none; margin-top: 10px; padding: 12px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #eee; }
        .btn-detail-toggle { width: 100%; padding: 10px; background: #fff; border: 1px solid #ced4da; color: #495057; border-radius: 6px; cursor: pointer; font-size: 12.5px; font-weight: 600; margin-top: 10px; transition: 0.2s; }
        .btn-detail-toggle:hover { background-color: #f1f3f5; border-color: #adb5bd; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; margin-bottom: 5px; }
        .info-grid p { margin: 0 !important; font-size: 13px; color: #555; display: flex; align-items: flex-start; line-height: 1.4; }
        .info-grid b { color: #333; width: 70px; flex-shrink: 0; display: inline-block; }

        .upd-badge { background: #d93025; color: white; font-size: 10px; padding: 2px 5px; border-radius: 4px; margin-left: 8px; }
        .highlight { color: #0056b3 !important; font-weight: bold; background: #e7f1ff; border-radius: 4px; padding: 1px 4px; display: inline; word-break: break-all; }

        .schedule-list { background-color: #f1f3f5; padding: 10px; border-radius: 8px; margin: 4px 0 6px 0; font-size: 13px; }
        .schedule-item { margin-bottom: 3px; display: flex; gap: 8px; }
        .sc-date { font-weight: bold; color: #0056b3; }
        
        .divider { border-top: 1px dashed #ddd; margin: 8px 0; }
        .total-pay-detail { color: #d93025; font-weight: bold; font-size: 1.1em; margin-top: 8px; display: block; }
        
        .note-box { padding: 12px; margin-top: 8px; font-size: 13.5px; border-radius: 6px; line-height: 1.6; word-break: break-all; }
        
        .pay-status-row { display: flex; gap: 6px; margin-top: 12px; }
        .status-box { flex: 1; padding: 8px 4px; text-align: center; border-radius: 6px; font-weight: bold; font-size: 11px; }
        .status-waiting { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-complete { background-color: #e9ecef; color: #6c757d; border: 1px solid #dee2e6; }
        
        .check-btn { width: 100%; padding: 12px; margin-top: 12px; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13.5px; }
        .confirmed-msg { display: block; margin-top: 12px; padding: 12px; text-align: center; background-color: #f8f9fa; color: #adb5bd; border-radius: 8px; font-weight: bold; font-size: 13.5px; }
        .logout-btn { background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }

        .list-container { display: flex; flex-direction: column; gap: 10px; }
        /* ë¦¬ìŠ¤íŠ¸ ê¸°ë³¸ ìŠ¤íƒ€ì¼: border-leftëŠ” ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë™ì  ì²˜ë¦¬ */
        .list-item { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #ccc; }
        .list-header { padding: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .lh-info { flex: 1; }
        .lh-date { font-size: 12px; color: #888; font-weight: bold; }
        .lh-title { font-size: 16px; font-weight: bold; color: #333; }
        .lh-status { font-size: 12px; padding: 4px 8px; border-radius: 12px; margin-left: 10px; }
        .st-wait { background: #fff3cd; color: #856404; }
        .st-ok { background: #d4edda; color: #155724; }
        .list-body { display: none; padding: 0 15px 15px 15px; border-top: 1px solid #eee; background-color: #fafafa; }
    </style>
</head>
<body>
    <div class="header"><h1>EDUMAKER ê°•ì‚¬ ì „ìš©</h1></div>
    <div class="container">
        <div class="top-bar">
            <div id="welcome-text" class="welcome-msg">ì •ë³´ ë¡œë”© ì¤‘...</div>
            <div style="display:flex; align-items:center; gap:10px;"><div class="view-toggle"><button class="toggle-btn active" id="btn-card" onclick="changeView('card')">ğŸ—‚ï¸ ì¹´ë“œí˜•</button><button class="toggle-btn" id="btn-list" onclick="changeView('list')">â˜° ë¦¬ìŠ¤íŠ¸í˜•</button></div><button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button></div>
        </div>
        <div id="card-view-container" class="assignment-grid"></div>
        <div id="list-view-container" class="list-container" style="display:none;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw", authDomain: "edumaker-teacher-d97ba.firebaseapp.com", projectId: "edumaker-teacher-d97ba", storageBucket: "edumaker-teacher-d97ba.firebasestorage.app", messagingSenderId: "532708143359", appId: "1:532708143359:web:89b9933da4c868127ddcca", measurementId: "G-JJ1TF77VBJ" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
        let assignmentsData = [];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDocs(query(collection(db, "users"), where("email", "==", user.email)));
                let dName = snap.empty ? "ê°•ì‚¬" : snap.docs[0].data().name;
                document.getElementById('welcome-text').innerHTML = `âœ¨ <b>${dName}(${user.email})</b> ê°•ì‚¬ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
                listenAssignments(user.email);
            } else location.href = "index.html";
        });

        function listenAssignments(email) {
            onSnapshot(query(collection(db, "assignments"), where("teacherEmail", "==", email), orderBy("createdAt", "desc")), (snapshot) => {
                assignmentsData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAssignments();
            });
        }

        window.changeView = (mode) => {
            document.getElementById('card-view-container').style.display = mode === 'card' ? 'grid' : 'none';
            document.getElementById('list-view-container').style.display = mode === 'list' ? 'flex' : 'none';
            document.getElementById('btn-card').className = `toggle-btn ${mode==='card'?'active':''}`;
            document.getElementById('btn-list').className = `toggle-btn ${mode==='list'?'active':''}`;
        }

        window.toggleCardDetail = (id, prefix = 'card') => {
            const el = document.getElementById(`${prefix}-detail-${id}`);
            const btn = document.getElementById(`${prefix}-btn-toggle-${id}`);
            if (el.style.display === 'block') {
                el.style.display = 'none';
                btn.innerText = 'â–¼ ìƒì„¸ ë‚´ì—­ ë³´ê¸°';
            } else {
                el.style.display = 'block';
                btn.innerText = 'â–² ìƒì„¸ ë‚´ì—­ ë‹«ê¸°';
            }
        }

        function renderAssignments() {
            const cardCon = document.getElementById('card-view-container'); const listCon = document.getElementById('list-view-container');
            let cardHtml = ""; let listHtml = "";

            assignmentsData.forEach(data => {
                const classHours = Number(data.classHours || 0); const hourlyRate = Number(data.hourlyRate || 0); const additionalCost = Number(data.additionalCost || 0);
                const lectureFee = classHours * hourlyRate; const totalGrossPay = lectureFee + additionalCost;
                const isConfirmed = data.status === 'í™•ì¸ì™„ë£Œ'; const showUpd = data.isUpdated && !isConfirmed;
                const updBadge = showUpd ? `<span class="upd-badge">ë‚´ìš©ë³€ê²½</span>` : "";

                const hlCli = (showUpd && data.changed_client) ? "highlight" : "";
                const hlSub = (showUpd && data.changed_subject) ? "highlight" : "";
                const hlAddr = (showUpd && data.changed_address) ? "highlight" : "";
                const hlRoom = (showUpd && data.changed_classRoom) ? "highlight" : "";
                const hlRole = (showUpd && data.changed_role) ? "highlight" : "";
                const hlSch = (showUpd && data.changed_schedule) ? "highlight" : "";
                const hlH = (showUpd && data.changed_hours) ? "highlight" : "";
                const hlR = (showUpd && data.changed_rate) ? "highlight" : "";
                const hlA = (showUpd && data.changed_addCost) ? "highlight" : "";
                const hlC = (showUpd && data.changed_comm) ? "highlight" : "";
                const hlTotal = (hlH || hlR || hlA) ? "highlight" : "";
                
                const noteBoxStyle = (showUpd && data.changed_note) 
                    ? "background:#e7f1ff; border-left:4px solid #0056b3; color:#0056b3; font-weight:bold;"
                    : "background:#fef9e7; border-left:4px solid #f1c40f; color:#666;";

                let schHtml = `<div class="schedule-list">`;
                data.date.split(', ').forEach((d, i) => { schHtml += `<div class="schedule-item"><span class="sc-date">ğŸ“… ${d}</span><span class="sc-time">â° ${data.time.split(', ')[i] || ''}</span></div>`; });
                schHtml += `</div>`;

                const generateCommonHtml = (prefix) => `
                    <div class="info-single">
                        <p><b>ğŸ“š ê°•ì¢Œëª…</b> : &nbsp;<span class="${hlSub}">${data.subject}</span></p>
                    </div>
                    <div class="info-single">
                        <p><b>ğŸ“ ê°•ì˜ì¥ì†Œ</b> : &nbsp;<span class="${hlAddr}"><a href="https://map.naver.com/v5/search/${encodeURIComponent(data.address)}" target="_blank" class="map-link" style="text-decoration: underline; color: inherit;">${data.address} ğŸ”—</a></span></p>
                    </div>
                    <div class="info-single">
                        <p><b>ğŸ« êµìœ¡ì¥ì†Œ</b> : &nbsp;<span class="${hlRoom}">${data.classRoom || 'ë¯¸ì •'}</span></p>
                    </div>
                    <div class="info-single">
                        <p><b>ğŸ–ï¸ ì—­í• </b> : &nbsp;<span class="${hlRole}">${data.role}</span></p>
                    </div>

                    <div style="margin-top: 10px; font-weight: bold; color: #555; font-size:13px;">ğŸ“† êµìœ¡ ì¼ì • ${showUpd && data.changed_schedule ? '(ë³€ê²½ë¨)' : ''}</div>
                    <div class="${hlSch}" style="display:inline-block; width:100%;">${schHtml}</div>

                    <button class="btn-detail-toggle" id="${prefix}-btn-toggle-${data.id}" onclick="toggleCardDetail('${data.id}', '${prefix}')">â–¼ ìƒì„¸ ë‚´ì—­ ë³´ê¸°</button>
                    
                    <div class="detail-section" id="${prefix}-detail-${data.id}">
                        <div class="info-grid">
                            <p><b>â³ ì´ ì‹œê°„</b> : &nbsp;<span class="${hlH}">${classHours}ì‹œê°„</span></p>
                            <p><b>ğŸ’° ì‹œê¸‰</b> : &nbsp;<span class="${hlR}">${hourlyRate.toLocaleString()}ì›</span></p>
                        </div>
                        <div class="info-grid">
                            <p><b>â• ì¶”ê°€ë¹„ìš©</b> : &nbsp;<span class="${hlA}">${additionalCost.toLocaleString()}ì›</span></p>
                            <p><b>ğŸ·ï¸ ì´ìš©ë£Œ</b> : &nbsp;<span class="${hlC}">${(data.serviceFee || 0).toLocaleString()}ì› (${data.commissionRate}%)</span></p>
                        </div>
                        <div class="divider" style="margin: 10px 0;"></div>
                        <p class="total-pay-detail"><b>ğŸ’µ ì´ ê°•ì‚¬ë£Œ</b> : &nbsp;<span class="${hlTotal}">${totalGrossPay.toLocaleString()}ì›</span></p>
                    </div>

                    ${data.note ? `<div class="note-box" style="${noteBoxStyle}"><b>ğŸ“ ë¹„ê³ :</b> &nbsp;${data.note.replace(/\n/g, '<br>')}</div>` : ''}
                    
                    <div class="pay-status-row">
                        <div class="status-box ${data.isPaidTeacher?'status-complete':'status-waiting'}">ê°•ì‚¬ë£Œ ${data.isPaidTeacher?'ì™„ë£Œ':'ëŒ€ê¸°'}</div>
                        <div class="status-box ${data.isPaidService?'status-complete':'status-waiting'}">ì´ìš©ë£Œ ${data.isPaidService?'ì™„ë£Œ':'ëŒ€ê¸°'}</div>
                    </div>
                    
                    ${isConfirmed ? `<span class="confirmed-msg">ğŸ‘ í™•ì¸ ì™„ë£Œë¨</span>` : `<button class="check-btn" onclick="confirmAssignment('${data.id}')">${showUpd ? 'ë³€ê²½ëœ ê°•ì˜ë‚´ìš© í™•ì¸í•˜ê¸°' : 'ê°•ì˜ ë°°ì • í™•ì¸í•˜ê¸°'}</button>`}`;

                // ğŸ”¥ í™•ì¸ ì‹œ ì´ˆë¡ìƒ‰(#28a745), ë¯¸í™•ì¸ ì‹œ ë¹¨ê°„ìƒ‰(#d93025) ì ìš©
                const statusColor = isConfirmed ? '#28a745' : '#d93025';

                // ì¹´ë“œí˜•: ìƒë‹¨ í…Œë‘ë¦¬(border-top) ìƒ‰ìƒ ë³€ê²½
                cardHtml += `<div class="card" style="border-top: 5px solid ${statusColor};"><h3><span class="${hlCli}">${data.client}</span> ${updBadge}</h3>${generateCommonHtml('card')}</div>`;
                
                // ë¦¬ìŠ¤íŠ¸í˜•: ì™¼ìª½ í…Œë‘ë¦¬(border-left) ìƒ‰ìƒ ë³€ê²½
                listHtml += `<div class="list-item" style="border-left-color:${statusColor}">
                    <div class="list-header" onclick="toggleDetail('${data.id}')"><div class="lh-info"><div class="lh-date">${data.date.split(', ')[0]}</div><div class="lh-title"><span class="${hlCli}">${data.client}</span> ${updBadge}</div></div><span class="lh-status ${isConfirmed?'st-ok':'st-wait'}">${isConfirmed?'í™•ì¸ì™„ë£Œ':'í™•ì¸ëŒ€ê¸°'}</span></div>
                    <div class="list-body" id="detail-${data.id}">${generateCommonHtml('list')}</div></div>`;
            });
            cardCon.innerHTML = cardHtml || '<div style="text-align:center; padding:40px; color:#888;">ë°°ì •ëœ ê°•ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; listCon.innerHTML = listHtml;
        }

        window.toggleDetail = (id) => { const el = document.getElementById(`detail-${id}`); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
        window.confirmAssignment = async (docId) => {
            if(!confirm("ë³€ê²½ëœ ê°•ì˜ ë°°ì • ë‚´ìš©ì„ í™•ì¸í•˜ì…¨ìŠµë‹ˆê¹Œ?")) return;
            await updateDoc(doc(db, "assignments", docId), { status: "í™•ì¸ì™„ë£Œ", isUpdated: false, changed_client: false, changed_subject: false, changed_address: false, changed_classRoom: false, changed_role: false, changed_schedule: false, changed_hours: false, changed_rate: false, changed_addCost: false, changed_comm: false, changed_note: false });
        }
        window.handleLogout = () => signOut(auth).then(() => { location.href = "index.html"; });
    </script>
</body>
</html>