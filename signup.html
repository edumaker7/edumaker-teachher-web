<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에듀메이커 - 강사 회원가입</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f4f7f9; padding: 20px; margin: 0; }
        .signup-container { background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); max-width: 450px; margin: 40px auto; }
        .logo { font-size: 24px; font-weight: 800; color: #0056b3; text-align: center; margin-bottom: 25px; cursor: pointer; }
        .input-group { margin-bottom: 18px; }
        label { display: block; font-size: 13px; font-weight: 600; color: #444; margin-bottom: 5px; }
        .required { color: #d93025; margin-left: 2px; }
        .guide-text { font-size: 11px; color: #d93025; font-weight: normal; margin-left: 5px; letter-spacing: -0.5px; }
        
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .btn-signup { 
            width: 100%; padding: 15px; background-color: #0056b3; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.3s;
        }
        .btn-signup:hover { background-color: #004494; }
        
        .btn-signup:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        
        .footer-links { margin-top: 20px; text-align: center; font-size: 13px; color: #888; }
        .footer-links a { text-decoration: none; color: #666; cursor: pointer; transition: 0.2s; }
        .footer-links a:hover { color: #0056b3; text-decoration: underline; }
        .footer-divider { margin: 0 10px; color: #ddd; }
        
        .privacy-agreement { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 25px 0; border: 1px solid #eee; }
        .privacy-label { display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #333; font-weight: 500; }
        .privacy-label input[type="checkbox"] { width: 18px; height: 18px; margin-right: 10px; cursor: pointer; }
    </style>
</head>
<body>
<div class="signup-container">
    <div class="logo" onclick="location.href='index.html'">EDUMAKER</div>
    
    <div class="input-group">
        <label>
            이메일주소(아이디) <span class="required">*</span>
            <span class="guide-text">※ ID로 사용되며 가입 후 변경 불가</span>
        </label>
        <input type="email" id="email" placeholder="example@gmail.com">
    </div>

    <div class="input-group">
        <label>비밀번호 <span class="required">*</span></label>
        <input type="password" id="password" placeholder="6자리 이상 입력하세요">
    </div>
    <div class="input-group">
        <label>비밀번호 확인 <span class="required">*</span></label>
        <input type="password" id="passwordConfirm" placeholder="비밀번호를 한 번 더 입력하세요">
    </div>
    <div class="input-group">
        <label>이름 <span class="required">*</span></label>
        <input type="text" id="name" placeholder="성함을 입력하세요">
    </div>
    <div class="input-group">
        <label>전화번호 <span class="required">*</span></label>
        <input type="tel" id="phone" placeholder="010-0000-0000" maxlength="13">
    </div>
    <div class="input-group">
        <label>활동지역 <span class="required">*</span></label>
        <input type="text" id="region" placeholder="예: 서울 강남구">
    </div>
    
    <div class="privacy-agreement">
        <label class="privacy-label">
            <input type="checkbox" id="privacyCheck">
            <span>(필수) <a onclick="openPrivacyPopup()" style="text-decoration: underline; color: #0056b3;">개인정보처리방침</a>에 동의합니다.</span>
        </label>
    </div>

    <button class="btn-signup" id="signupBtn">회원가입 완료</button>
    
    <div class="footer-links">
        <a href="index.html">로그인 하기</a>
        <span class="footer-divider">|</span>
        <a id="findIdBtn">아이디 찾기</a>
        <span class="footer-divider">|</span>
        <a id="findPwBtn">비밀번호 찾기</a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw",
        authDomain: "edumaker-teacher-d97ba.firebaseapp.com",
        projectId: "edumaker-teacher-d97ba",
        storageBucket: "edumaker-teacher-d97ba.firebasestorage.app",
        messagingSenderId: "532708143359",
        appId: "1:532708143359:web:89b9933da4c868127ddcca",
        measurementId: "G-JJ1TF77VBJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    emailjs.init("0VVyqizaUqeIcG7FU");

    function clearForm() {
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        document.getElementById('passwordConfirm').value = '';
        document.getElementById('name').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('region').value = '';
        document.getElementById('privacyCheck').checked = false;
    }

    const phoneInput = document.getElementById('phone');
    phoneInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/[^0-9]/g, '');
        let formatted = '';
        if (value.length <= 3) formatted = value;
        else if (value.length <= 7) formatted = value.slice(0, 3) + '-' + value.slice(3);
        else formatted = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
        e.target.value = formatted;
    });

    function openPopup(url, name, width, height) {
        const left = (window.screen.width / 2) - (width / 2);
        const top = (window.screen.height / 2) - (height / 2);
        window.open(url, name, `width=${width},height=${height},left=${left},top=${top},scrollbars=no,resizable=no`);
    }

    window.openPrivacyPopup = function() {
        openPopup('privacy.html', 'PrivacyPolicy', 600, 800);
    }

    document.getElementById('findIdBtn').addEventListener('click', () => {
        openPopup('find_id.html', 'FindID', 450, 500);
    });

    document.getElementById('findPwBtn').addEventListener('click', () => {
        openPopup('find_pw.html', 'FindPW', 450, 580);
    });

    function validateEmail(email) {
        const re = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return re.test(String(email).toLowerCase());
    }

    function setButtonLoading(isLoading) {
        const btn = document.getElementById('signupBtn');
        if (isLoading) {
            btn.disabled = true; 
            btn.innerText = "가입 처리 중... ⏳"; 
        } else {
            btn.disabled = false; 
            btn.innerText = "회원가입 완료"; 
        }
    }

    document.getElementById('signupBtn').addEventListener('click', async () => {
        const email = document.getElementById('email').value.trim();
        const pw = document.getElementById('password').value;
        const pwConfirm = document.getElementById('passwordConfirm').value;
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const region = document.getElementById('region').value;
        const privacyCheck = document.getElementById('privacyCheck').checked;

        if(!email || !pw || !name || !phone || !region || !privacyCheck) {
            alert("모든 필수 항목을 입력하고 동의해 주세요.");
            return;
        }

        if (!validateEmail(email)) {
            alert("이메일 형식이 올바르지 않습니다.\n(@ 포함 여부 등을 확인해 주세요)");
            return;
        }

        if(pw !== pwConfirm) {
            alert("비밀번호가 일치하지 않습니다.");
            return; 
        }

        setButtonLoading(true);

        try {
            const q = query(collection(db, "users"), where("phone", "==", phone));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                alert("이미 가입된 휴대폰 번호입니다.\n[로그인] 하시거나 [아이디 찾기]를 이용해 주세요.");
                clearForm();
                setButtonLoading(false);
                return;
            }

            const userCredential = await createUserWithEmailAndPassword(auth, email, pw);
            const user = userCredential.user;

            await setDoc(doc(db, "users", user.uid), {
                email: email,
                name: name,
                phone: phone,
                region: region,
                createdAt: new Date()
            });

            const templateParams = {
                teacherName: name,
                teacherEmail: email,
                teacherPhone: phone,
                teacherRegion: region
            };
            
            await emailjs.send('service_6f7u7om', 'template_wqsqk8s', templateParams);

            alert("에듀메이커 강사 등록이 완료되었습니다!\n로그인 후 이용해 주세요.");
            window.location.href = "index.html";

        } catch (error) {
            setButtonLoading(false);

            if(error.code === 'auth/email-already-in-use') {
                alert("이미 가입된 이메일입니다.\n[로그인] 하시거나 [비밀번호 찾기]를 이용해 주세요.");
                clearForm();
            } else if(error.code === 'auth/weak-password') {
                alert("비밀번호는 6자리 이상이어야 합니다.");
            } else {
                alert("가입 오류: " + error.message);
            }
        }
    });
</script>
</body>
</html>