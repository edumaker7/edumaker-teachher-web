<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë“€ë©”ì´ì»¤ - ê°•ì‚¬ íšŒì›ê°€ì…</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f4f7f9; padding: 20px; margin: 0; }
        .signup-container { background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); max-width: 450px; margin: 40px auto; }
        .logo { font-size: 24px; font-weight: 800; color: #0056b3; text-align: center; margin-bottom: 25px; cursor: pointer; }
        .input-group { margin-bottom: 18px; }
        label { display: block; font-size: 13px; font-weight: 600; color: #444; margin-bottom: 5px; }
        .required { color: #d93025; margin-left: 2px; }
        .guide-text { font-size: 11px; color: #d93025; font-weight: normal; margin-left: 5px; letter-spacing: -0.5px; }
        
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .btn-signup { 
            width: 100%; padding: 15px; background-color: #0056b3; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.3s;
        }
        .btn-signup:hover { background-color: #004494; }
        
        /* ğŸ”¥ [ì¶”ê°€] ë²„íŠ¼ ë¹„í™œì„±í™” ì‹œ ìŠ¤íƒ€ì¼ (íšŒìƒ‰ ì²˜ë¦¬) */
        .btn-signup:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        
        .footer-links { margin-top: 20px; text-align: center; font-size: 13px; color: #888; }
        .footer-links a { text-decoration: none; color: #666; cursor: pointer; transition: 0.2s; }
        .footer-links a:hover { color: #0056b3; text-decoration: underline; }
        .footer-divider { margin: 0 10px; color: #ddd; }
        
        .privacy-agreement { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 25px 0; border: 1px solid #eee; }
        .privacy-label { display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #333; font-weight: 500; }
        .privacy-label input[type="checkbox"] { width: 18px; height: 18px; margin-right: 10px; cursor: pointer; }
    </style>
</head>
<body>
<div class="signup-container">
    <div class="logo" onclick="location.href='index.html'">EDUMAKER</div>
    
    <div class="input-group">
        <label>
            ì´ë©”ì¼ì£¼ì†Œ(ì•„ì´ë””) <span class="required">*</span>
            <span class="guide-text">â€» IDë¡œ ì‚¬ìš©ë˜ë©° ê°€ì… í›„ ë³€ê²½ ë¶ˆê°€</span>
        </label>
        <input type="email" id="email" placeholder="example@gmail.com">
    </div>

    <div class="input-group">
        <label>ë¹„ë°€ë²ˆí˜¸ <span class="required">*</span></label>
        <input type="password" id="password" placeholder="6ìë¦¬ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”">
    </div>
    <div class="input-group">
        <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="required">*</span></label>
        <input type="password" id="passwordConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆ ë” ì…ë ¥í•˜ì„¸ìš”">
    </div>
    <div class="input-group">
        <label>ì´ë¦„ <span class="required">*</span></label>
        <input type="text" id="name" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>
    <div class="input-group">
        <label>ì „í™”ë²ˆí˜¸ <span class="required">*</span></label>
        <input type="tel" id="phone" placeholder="010-0000-0000" maxlength="13">
    </div>
    <div class="input-group">
        <label>í™œë™ì§€ì—­ <span class="required">*</span></label>
        <input type="text" id="region" placeholder="ì˜ˆ: ì„œìš¸ ê°•ë‚¨êµ¬">
    </div>
    
    <div class="privacy-agreement">
        <label class="privacy-label">
            <input type="checkbox" id="privacyCheck">
            <span>(í•„ìˆ˜) <a onclick="openPrivacyPopup()" style="text-decoration: underline; color: #0056b3;">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
        </label>
    </div>

    <button class="btn-signup" id="signupBtn">íšŒì›ê°€ì… ì™„ë£Œ</button>
    
    <div class="footer-links">
        <a href="index.html">ë¡œê·¸ì¸ í•˜ê¸°</a>
        <span class="footer-divider">|</span>
        <a id="findIdBtn">ì•„ì´ë”” ì°¾ê¸°</a>
        <span class="footer-divider">|</span>
        <a id="findPwBtn">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw",
        authDomain: "edumaker-teacher-d97ba.firebaseapp.com",
        projectId: "edumaker-teacher-d97ba",
        storageBucket: "edumaker-teacher-d97ba.firebasestorage.app",
        messagingSenderId: "532708143359",
        appId: "1:532708143359:web:89b9933da4c868127ddcca",
        measurementId: "G-JJ1TF77VBJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    emailjs.init("0VVyqizaUqeIcG7FU");

    function clearForm() {
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        document.getElementById('passwordConfirm').value = '';
        document.getElementById('name').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('region').value = '';
        document.getElementById('privacyCheck').checked = false;
    }

    const phoneInput = document.getElementById('phone');
    phoneInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/[^0-9]/g, '');
        let formatted = '';
        if (value.length <= 3) formatted = value;
        else if (value.length <= 7) formatted = value.slice(0, 3) + '-' + value.slice(3);
        else formatted = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
        e.target.value = formatted;
    });

    function openPopup(url, name, width, height) {
        const left = (window.screen.width / 2) - (width / 2);
        const top = (window.screen.height / 2) - (height / 2);
        window.open(url, name, `width=${width},height=${height},left=${left},top=${top},scrollbars=no,resizable=no`);
    }

    window.openPrivacyPopup = function() {
        openPopup('privacy.html', 'PrivacyPolicy', 600, 800);
    }

    document.getElementById('findIdBtn').addEventListener('click', () => {
        openPopup('find_id.html', 'FindID', 450, 500);
    });

    document.getElementById('findPwBtn').addEventListener('click', () => {
        openPopup('find_pw.html', 'FindPW', 450, 580);
    });

    function validateEmail(email) {
        const re = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return re.test(String(email).toLowerCase());
    }

    // ğŸ”¥ [ì¶”ê°€] ë²„íŠ¼ ë¡œë”© ìƒíƒœ ì œì–´ í•¨ìˆ˜
    function setButtonLoading(isLoading) {
        const btn = document.getElementById('signupBtn');
        if (isLoading) {
            btn.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            btn.innerText = "ê°€ì… ì²˜ë¦¬ ì¤‘... â³"; // í…ìŠ¤íŠ¸ ë³€ê²½
        } else {
            btn.disabled = false; // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            btn.innerText = "íšŒì›ê°€ì… ì™„ë£Œ"; // í…ìŠ¤íŠ¸ ë³µêµ¬
        }
    }

    document.getElementById('signupBtn').addEventListener('click', async () => {
        const email = document.getElementById('email').value.trim();
        const pw = document.getElementById('password').value;
        const pwConfirm = document.getElementById('passwordConfirm').value;
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const region = document.getElementById('region').value;
        const privacyCheck = document.getElementById('privacyCheck').checked;

        // 1. ìœ íš¨ì„± ê²€ì‚¬ (ì—¬ê¸°ì„œëŠ” ì•„ì§ ë¡œë”© ì•ˆ ê±º)
        if(!email || !pw || !name || !phone || !region || !privacyCheck) {
            alert("ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ê³  ë™ì˜í•´ ì£¼ì„¸ìš”.");
            return;
        }

        if (!validateEmail(email)) {
            alert("ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\n(@ í¬í•¨ ì—¬ë¶€ ë“±ì„ í™•ì¸í•´ ì£¼ì„¸ìš”)");
            return;
        }

        if(pw !== pwConfirm) {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return; // ğŸ›‘ returnì´ ìˆì–´ ì—¬ê¸°ì„œ ë©ˆì¶¤
        }

        // 2. ëª¨ë“  ê²€ì‚¬ í†µê³¼ -> ë¡œë”© ì‹œì‘!
        setButtonLoading(true);

        try {
            // ì „í™”ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬
            const q = query(collection(db, "users"), where("phone", "==", phone));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                alert("ì´ë¯¸ ê°€ì…ëœ íœ´ëŒ€í° ë²ˆí˜¸ì…ë‹ˆë‹¤.\n[ë¡œê·¸ì¸] í•˜ì‹œê±°ë‚˜ [ì•„ì´ë”” ì°¾ê¸°]ë¥¼ ì´ìš©í•´ ì£¼ì„¸ìš”.");
                clearForm();
                setButtonLoading(false); // ğŸ›‘ ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë³µêµ¬
                return;
            }

            // Firebase ê°€ì… & DB ì €ì¥ & ë©”ì¼ ë°œì†¡
            const userCredential = await createUserWithEmailAndPassword(auth, email, pw);
            const user = userCredential.user;

            await setDoc(doc(db, "users", user.uid), {
                email: email,
                name: name,
                phone: phone,
                region: region,
                createdAt: new Date()
            });

            const templateParams = {
                teacherName: name,
                teacherEmail: email,
                teacherPhone: phone,
                teacherRegion: region
            };
            
            await emailjs.send('service_6f7u7om', 'template_wqsqk8s', templateParams);

            alert("ì—ë“€ë©”ì´ì»¤ ê°•ì‚¬ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\në¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.");
            window.location.href = "index.html";

        } catch (error) {
            // ğŸ›‘ ì—ëŸ¬ ë°œìƒ ì‹œ ë²„íŠ¼ ë³µêµ¬
            setButtonLoading(false);

            if(error.code === 'auth/email-already-in-use') {
                alert("ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.\n[ë¡œê·¸ì¸] í•˜ì‹œê±°ë‚˜ [ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°]ë¥¼ ì´ìš©í•´ ì£¼ì„¸ìš”.");
                clearForm();
            } else if(error.code === 'auth/weak-password') {
                alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
            } else {
                alert("ê°€ì… ì˜¤ë¥˜: " + error.message);
            }
        }
    });
</script>
</body>
</html>