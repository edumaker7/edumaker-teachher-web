<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì˜ ì •ë³´ ìˆ˜ì • - EDUMAKER</title>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f3f5; padding: 20px; margin: 0; }
        
        /* ğŸ”¥ [ìˆ˜ì •] max-widthì™€ ë°•ìŠ¤ ì‚¬ì´ì§•ìœ¼ë¡œ ë°˜ì‘í˜• ëŒ€ì‘ */
        .edit-box { 
            background: white; padding: 30px; border-radius: 12px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            max-width: 650px; width: 100%; margin: 0 auto; 
            box-sizing: border-box; 
        }
        
        h2 { color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .input-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; font-size: 14px; }
        .required { color: #d93025; margin-left: 3px; font-weight: bold; }
        
        /* ğŸ”¥ [ìˆ˜ì •] í°íŠ¸ 16px (ì•„ì´í° í™•ëŒ€ ë°©ì§€) */
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        /* ë°˜ì‘í˜•: í™”ë©´ ì‘ì•„ì§€ë©´ ì„¸ë¡œ ë°°ì¹˜ */
        .row-group { display: flex; gap: 15px; margin-bottom: 18px; flex-wrap: wrap; }
        .half-input { flex: 1; min-width: 200px; }
        
        .address-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .addr-search-group { flex: 7; display: flex; gap: 5px; min-width: 200px; }
        .addr-search-group input { flex: 1; background-color: #fff; }
        .btn-addr-search { width: 50px; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        #classRoom { flex: 3; min-width: 150px; }
        
        .role-wrapper { display: flex; gap: 10px; flex-wrap: wrap; }
        #roleSelect { flex: 1; min-width: 120px; }
        #roleInputDirect { flex: 1; display: none; min-width: 150px; }
        
        .schedule-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; }
        .schedule-row input[type="date"] { flex: 2; min-width: 130px; } 
        .time-picker-group { display: flex; gap: 2px; align-items: center; flex: 4; justify-content: flex-end; flex-wrap: wrap; }
        .time-picker-group select { padding: 8px 2px; text-align: center; font-size: 13px; height: 42px; width: auto; }
        .hour-select, .min-select { width: 55px !important; }
        .ampm-select { width: 65px !important; background-color: #fff; }
        .tilde { font-weight: bold; color: #888; margin: 0 4px; }
        
        .btn-remove-row { background-color: #ff6b6b; color: white; border: none; border-radius: 8px; width: 35px; height: 42px; cursor: pointer; font-weight: bold; font-size: 18px; }
        .btn-add-row { background-color: #51cf66; color: white; border: none; border-radius: 8px; padding: 10px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 15px; }
        
        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group-bottom { display: flex; gap: 10px; margin-top: 20px; }
        .btn-update { flex: 2; padding: 16px; background-color: #0056b3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 17px; }
        .btn-close { flex: 1; padding: 16px; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 17px; }
        
        .btn-update:hover { background-color: #004494; }
        .btn-close:hover { background-color: #5a6268; }
    </style>
</head>
<body>

<div class="edit-box">
    <h2>ğŸ“ ê°•ì˜ ì •ë³´ ìˆ˜ì •</h2>
    
    <div class="row-group">
        <div class="half-input"><label>ê°•ì‚¬ ì„±í•¨</label><input type="text" id="teacherName" readonly style="background:#f1f1f1;"></div>
        <div class="half-input"><label>ê°•ì‚¬ ì´ë©”ì¼</label><input type="text" id="teacherEmail" readonly style="background:#f1f1f1;"></div>
    </div>
    
    <div class="row-group">
        <div class="half-input"><label>ê°•ì˜ì²˜ <span class="required">*</span></label><input type="text" id="client"></div>
        <div class="half-input"><label>ê°•ì¢Œëª… <span class="required">*</span></label><input type="text" id="subject"></div>
    </div>
    
    <div class="input-group">
        <label>ê°•ì˜ ì¥ì†Œ <span class="required">*</span></label>
        <div class="address-row">
            <div class="addr-search-group"><input type="text" id="address" placeholder="ì£¼ì†Œ ì§ì ‘ ì…ë ¥ ë˜ëŠ” ê²€ìƒ‰"><button type="button" class="btn-addr-search" onclick="openDaumPostcode()">ğŸ”</button></div>
            <input type="text" id="classRoom" placeholder="ìƒì„¸ì¥ì†Œ">
        </div>
    </div>
    
    <div class="input-group">
        <label>ì—­í•  <span class="required">*</span></label>
        <div class="role-wrapper">
            <select id="roleSelect"><option value="">ì„ íƒí•˜ì„¸ìš”</option><option value="ì£¼ê°•ì‚¬">ì£¼ê°•ì‚¬</option><option value="ë³´ì¡°ê°•ì‚¬">ë³´ì¡°ê°•ì‚¬</option><option value="ì•ˆì „ìš”ì›">ì•ˆì „ìš”ì›</option><option value="direct">ì§ì ‘ ì…ë ¥ (ê¸°íƒ€)</option></select>
            <input type="text" id="roleInputDirect" placeholder="ì—­í•  ì§ì ‘ ì…ë ¥">
        </div>
    </div>
    
    <div class="input-group">
        <label>êµìœ¡ ì¼ì • <span class="required">*</span></label>
        <div id="scheduleContainer"></div>
        <button type="button" class="btn-add-row" id="addScheduleBtn">+ ì¼ì • ì¶”ê°€í•˜ê¸°</button>
    </div>
    
    <div class="row-group">
        <div class="half-input"><label>ì´ ê°•ì˜ ì‹œê°„ <span class="required">*</span></label><input type="number" id="classHours"></div>
        <div class="half-input"><label>ì‹œê°„ë‹¹ ê°•ì‚¬ë£Œ <span class="required">*</span></label><input type="text" id="hourlyRate"></div>
    </div>
    
    <div class="row-group">
        <div class="half-input"><label>ì¶”ê°€ ë¹„ìš©</label><input type="text" id="additionalCost"></div>
        <div class="half-input"><label>ì„œë¹„ìŠ¤ì´ìš©ë£Œ (%)</label><input type="number" id="commissionRate"></div>
    </div>
    
    <div class="input-group"><label>ë¹„ê³ </label><textarea id="note" style="height: 60px;"></textarea></div>
    
    <div class="btn-group-bottom">
        <button class="btn-close" onclick="window.close()">ë‹«ê¸°</button>
        <button class="btn-update" id="updateBtn">ìˆ˜ì • ë‚´ìš© ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<script>
    function openDaumPostcode() {
        new daum.Postcode({ oncomplete: function(data) {
            document.getElementById("address").value = data.roadAddress || data.jibunAddress;
            document.getElementById("classRoom").focus();
        }}).open();
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw", authDomain: "edumaker-teacher-d97ba.firebaseapp.com", projectId: "edumaker-teacher-d97ba", storageBucket: "edumaker-teacher-d97ba.firebasestorage.app", messagingSenderId: "532708143359", appId: "1:532708143359:web:89b9933da4c868127ddcca", measurementId: "G-JJ1TF77VBJ" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('id');

    let originalData = {}; 

    function createHourOptions(selected) {
        let options = ''; for(let i=1; i<=12; i++) { let val = i.toString().padStart(2, '0'); options += `<option value="${val}" ${val === selected ? 'selected' : ''}>${val}</option>`; } return options;
    }
    function createMinuteOptions(selected) {
        let options = ''; for(let i=0; i<60; i+=5) { let val = i.toString().padStart(2, '0'); options += `<option value="${val}" ${val === selected ? 'selected' : ''}>${val}</option>`; } return options;
    }

    window.addScheduleRow = function(dateValue = '', timeString = '') {
        const container = document.getElementById('scheduleContainer');
        const row = document.createElement('div');
        row.className = 'schedule-row';
        let t = { sAmpm: 'ì˜¤í›„', sH: '02', sM: '00', eAmpm: 'ì˜¤í›„', eH: '04', eM: '00' };
        if(timeString) {
            try {
                const parts = timeString.split(' ~ ');
                const start = parts[0].split(' '); const end = parts[1].split(' ');
                t.sAmpm = start[0]; t.sH = start[1].split(':')[0]; t.sM = start[1].split(':')[1];
                t.eAmpm = end[0]; t.eH = end[1].split(':')[0]; t.eM = end[1].split(':')[1];
            } catch(e) {}
        }
        row.innerHTML = `<input type="date" class="input-date" value="${dateValue}"><div class="time-picker-group"><select class="ampm-start ampm-select"><option value="ì˜¤ì „" ${t.sAmpm==='ì˜¤ì „'?'selected':''}>ì˜¤ì „</option><option value="ì˜¤í›„" ${t.sAmpm==='ì˜¤í›„'?'selected':''}>ì˜¤í›„</option></select><select class="hour-start hour-select">${createHourOptions(t.sH)}</select><span>:</span><select class="min-start min-select">${createMinuteOptions(t.sM)}</select><span class="tilde">~</span><select class="ampm-end ampm-select"><option value="ì˜¤ì „" ${t.eAmpm==='ì˜¤ì „'?'selected':''}>ì˜¤ì „</option><option value="ì˜¤í›„" ${t.eAmpm==='ì˜¤í›„'?'selected':''}>ì˜¤í›„</option></select><select class="hour-end hour-select">${createHourOptions(t.eH)}</select><span>:</span><select class="min-end min-select">${createMinuteOptions(t.eM)}</select></div><button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">-</button>`;
        container.appendChild(row);
    }

    if (docId) {
        getDoc(doc(db, "assignments", docId)).then((docSnap) => {
            if (docSnap.exists()) {
                originalData = docSnap.data(); 
                document.getElementById('teacherName').value = originalData.teacherName;
                document.getElementById('teacherEmail').value = originalData.teacherEmail;
                document.getElementById('client').value = originalData.client;
                document.getElementById('subject').value = originalData.subject;
                document.getElementById('address').value = originalData.address;
                document.getElementById('classRoom').value = originalData.classRoom || '';
                document.getElementById('classHours').value = originalData.classHours;
                document.getElementById('hourlyRate').value = Number(originalData.hourlyRate).toLocaleString();
                document.getElementById('additionalCost').value = Number(originalData.additionalCost || 0).toLocaleString();
                document.getElementById('commissionRate').value = originalData.commissionRate || 0;
                document.getElementById('note').value = originalData.note || '';

                const roles = ["ì£¼ê°•ì‚¬", "ë³´ì¡°ê°•ì‚¬", "ì•ˆì „ìš”ì›"];
                if (roles.includes(originalData.role)) document.getElementById('roleSelect').value = originalData.role;
                else if(originalData.role) { document.getElementById('roleSelect').value = "direct"; document.getElementById('roleInputDirect').style.display='block'; document.getElementById('roleInputDirect').value=originalData.role; }
                const dates = originalData.date ? originalData.date.split(', ') : [];
                const times = originalData.time ? originalData.time.split(', ') : [];
                if(dates.length > 0) dates.forEach((d, i) => addScheduleRow(d, times[i]));
                else addScheduleRow();
            }
        });
    }

    document.getElementById('roleSelect').addEventListener('change', function() {
        const dInput = document.getElementById('roleInputDirect');
        if(this.value === 'direct') { dInput.style.display = 'block'; dInput.focus(); }
        else { dInput.style.display = 'none'; dInput.value = ''; }
    });

    function handleComma(e) { let v = e.target.value.replace(/[^0-9]/g, ''); e.target.value = v ? Number(v).toLocaleString() : ''; }
    document.getElementById('hourlyRate').addEventListener('input', handleComma);
    document.getElementById('additionalCost').addEventListener('input', handleComma);
    document.getElementById('addScheduleBtn').onclick = () => addScheduleRow();

    document.getElementById('updateBtn').onclick = async () => {
        const newClient = document.getElementById('client').value.trim();
        const newSub = document.getElementById('subject').value.trim();
        const newAddr = document.getElementById('address').value.trim();
        const newRoom = document.getElementById('classRoom').value.trim();
        const newHours = Number(document.getElementById('classHours').value);
        const newRate = Number(document.getElementById('hourlyRate').value.replace(/,/g, ''));
        const newAdd = Number(document.getElementById('additionalCost').value.replace(/,/g, ''));
        const newComm = Number(document.getElementById('commissionRate').value);
        const newNote = document.getElementById('note').value.trim();
        
        let newRole = document.getElementById('roleSelect').value;
        if (newRole === 'direct') newRole = document.getElementById('roleInputDirect').value.trim();

        const rows = document.querySelectorAll('.schedule-row');
        let dList = []; let tList = [];
        rows.forEach(row => {
            const d = row.querySelector('.input-date').value;
            const ts = `${row.querySelector('.ampm-start').value} ${row.querySelector('.hour-start').value}:${row.querySelector('.min-start').value}`;
            const te = `${row.querySelector('.ampm-end').value} ${row.querySelector('.hour-end').value}:${row.querySelector('.min-end').value}`;
            if(d) { dList.push(d); tList.push(`${ts} ~ ${te}`); }
        });
        const newDate = dList.join(', '); const newTime = tList.join(', ');

        const changedCli = newClient !== (originalData.client || "").trim();
        const changedSub = newSub !== (originalData.subject || "").trim();
        const changedAddr = newAddr !== (originalData.address || "").trim();
        const changedRoom = newRoom !== (originalData.classRoom || "").trim();
        const changedRole = newRole !== (originalData.role || "").trim();
        const changedSch = (newDate !== originalData.date) || (newTime !== originalData.time);
        const changedH = newHours !== Number(originalData.classHours || 0);
        const changedR = newRate !== Number(originalData.hourlyRate || 0);
        const changedA = newAdd !== Number(originalData.additionalCost || 0);
        const changedC = newComm !== Number(originalData.commissionRate || 0);
        const changedN = newNote !== (originalData.note || "").trim();

        try {
            await updateDoc(doc(db, "assignments", docId), {
                client: newClient, subject: newSub, address: newAddr, classRoom: newRoom, role: newRole,
                date: newDate, time: newTime, classHours: newHours, hourlyRate: newRate, additionalCost: newAdd, commissionRate: newComm,
                serviceFee: Math.floor((newHours * newRate) * (newComm / 100)), note: newNote,
                status: "ë°°ì •ì™„ë£Œ", isUpdated: true, isPaidTeacher: false, isPaidService: false,
                changed_client: changedCli, changed_subject: changedSub, changed_address: changedAddr, 
                changed_classRoom: changedRoom, changed_role: changedRole, changed_schedule: changedSch, 
                changed_hours: changedH, changed_rate: changedR, changed_addCost: changedA, 
                changed_comm: changedC, changed_note: changedN
            });
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); window.close(); 
        } catch (e) { alert("ìˆ˜ì • ì˜¤ë¥˜: " + e.message); }
    };
</script>
</body>
</html>