<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì˜ ì •ë³´ ìˆ˜ì • - EDUMAKER</title>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f3f5; padding: 20px; margin: 0; }
        .edit-box { 
            background: white; padding: 30px; border-radius: 12px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            max-width: 680px; width: 100%; margin: 0 auto; /* âœ… adminê³¼ ë™ì¼í•˜ê²Œ 680pxë¡œ ê³ ì • */
            box-sizing: border-box; 
        }
        h2 { color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .input-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .row-group { display: flex; gap: 15px; margin-bottom: 18px; flex-wrap: wrap; }
        .half-input { flex: 1; min-width: 200px; }
        
        /* âœ… 3ì—´ ë°°ì¹˜ë¥¼ ìœ„í•œ ë„ˆë¹„ ì¡°ì • */
        .time-narrow-input { flex: 1.2; min-width: 80px; }
        .fee-input { flex: 2; min-width: 140px; }

        .addr-search-group { flex: 1; display: flex; gap: 5px; }
        .btn-addr-search { width: 50px; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        
        .role-wrapper { display: flex; gap: 10px; flex-wrap: wrap; }
        #roleSelect { flex: 1; min-width: 120px; }
        #roleInputDirect { flex: 1; display: none; min-width: 150px; }
        
        .schedule-row { 
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; 
            align-items: center; padding: 12px; 
            background-color: #f1f3f5; border-radius: 8px; border: 1px solid #e9ecef;
        }
        .schedule-row input[type="date"] { 
            flex: 1; min-width: 140px; background: #fff; border: 1px solid #ced4da;
        } 
        .time-picker-group { display: flex; align-items: center; gap: 5px; flex: 2; justify-content: flex-end; flex-wrap: wrap; }
        .time-set {
            display: flex; align-items: center; gap: 2px;
            background: #fff; border: 1px solid #ced4da; border-radius: 6px;
            padding: 0 5px; height: 45px;
        }
        .time-set select {
            width: auto !important; border: none; background: transparent;
            padding: 0 2px; font-size: 14px; text-align: center; height: 100%;
        }
        .ampm-select { font-weight: bold; color: #0056b3; width: 55px !important; }
        .hour-select, .min-select { width: 45px !important; }
        .tilde { font-weight: bold; color: #888; margin: 0 2px; }
        .btn-remove-row { 
            background-color: #ff6b6b; color: white; border: none; 
            border-radius: 6px; width: 40px; height: 45px; 
            cursor: pointer; font-weight: bold; font-size: 20px; 
            display: flex; align-items: center; justify-content: center;
        }
        .btn-add-row { background-color: #51cf66; color: white; border: none; border-radius: 8px; padding: 10px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 15px; }
        .btn-group-bottom { display: flex; gap: 10px; margin-top: 20px; }
        .btn-update { flex: 2; padding: 16px; background-color: #0056b3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 17px; }
        .btn-close { flex: 1; padding: 16px; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 17px; }

        @media (max-width: 600px) {
            .schedule-row input[type="date"] { width: 100%; flex: 100%; margin-bottom: 5px; }
            .time-picker-group { width: 100%; justify-content: space-between; flex: 100%; }
            .time-set { flex: 1; justify-content: center; } 
            .btn-remove-row { width: 100%; margin-top: 5px; height: 35px; }
        }
    </style>
</head>
<body>

<div class="edit-box">
    <h2>ğŸ“ ê°•ì˜ ì •ë³´ ìˆ˜ì •</h2>
    
    <div class="row-group">
        <div class="half-input"><label>ê°•ì‚¬ ì„±í•¨</label><input type="text" id="teacherName" readonly style="background:#f1f1f1;"></div>
        <div class="half-input"><label>ê°•ì‚¬ ì´ë©”ì¼</label><input type="text" id="teacherEmail" readonly style="background:#f1f1f1;"></div>
    </div>

    <div class="row-group">
        <div class="half-input"><label>ê°•ì‚¬ ì „í™”ë²ˆí˜¸</label><input type="text" id="phone"></div>
        <div class="half-input"><label>ê°•ì˜ì˜ë¢°ì²˜</label><input type="text" id="requestClient"></div>
    </div>
    
    <div class="row-group">
        <div class="half-input"><label>ê°•ì˜ì²˜</label><input type="text" id="client"></div>
        <div class="half-input"><label>ê°•ì¢Œëª…</label><input type="text" id="subject"></div>
    </div>
    
    <div class="input-group">
        <label>ê°•ì˜ ì¥ì†Œ (ì£¼ì†Œ)</label>
        <div class="address-row">
            <div class="addr-search-group">
                <input type="text" id="address" placeholder="ì£¼ì†Œ ì§ì ‘ ì…ë ¥ ë˜ëŠ” ê²€ìƒ‰">
                <button type="button" class="btn-addr-search" onclick="openDaumPostcode()">ğŸ”</button>
            </div>
        </div>
    </div>
    
    <div class="input-group">
        <label>ì—­í• </label>
        <div class="role-wrapper">
            <select id="roleSelect">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì£¼ê°•ì‚¬">ì£¼ê°•ì‚¬</option>
                <option value="ë³´ì¡°ê°•ì‚¬">ë³´ì¡°ê°•ì‚¬</option>
                <option value="ì•ˆì „ìš”ì›">ì•ˆì „ìš”ì›</option>
                <option value="direct">ì§ì ‘ ì…ë ¥ (ê¸°íƒ€)</option>
            </select>
            <input type="text" id="roleInputDirect" placeholder="ì—­í•  ì§ì ‘ ì…ë ¥">
        </div>
    </div>
    
    <div class="input-group">
        <label>êµìœ¡ ì¼ì •</label>
        <div id="scheduleContainer"></div>
        <button type="button" class="btn-add-row" id="addScheduleBtn"> + ì¼ì • ì¶”ê°€í•˜ê¸°</button>
    </div>
    
    <div class="row-group">
        <div class="time-narrow-input"><label>ì´ ê°•ì˜ ì‹œê°„</label><input type="number" id="classHours"></div>
        <div class="fee-input"><label>ì‹œê¸‰ (ì§€ê¸‰ìš©)</label><input type="text" id="hourlyRate"></div>
        <div class="fee-input"><label>ì›ì‹œê¸‰ (ì˜ë¢°ìš©)</label><input type="text" id="originalFee"></div>
    </div>
    
    <div class="row-group">
        <div class="half-input"><label>ì¶”ê°€ ë¹„ìš©</label><input type="text" id="additionalCost"></div>
        <div class="half-input"><label>ì„œë¹„ìŠ¤ì´ìš©ë£Œ (%)</label><input type="number" id="commissionRate"></div>
    </div>
    
    <div class="input-group"><label>ë¹„ê³ </label><textarea id="note" style="height: 60px;"></textarea></div>
    
    <div class="btn-group-bottom">
        <button class="btn-close" onclick="window.close()">ë‹«ê¸°</button>
        <button class="btn-update" id="updateBtn">ìˆ˜ì • ë‚´ìš© ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<script>
    function openDaumPostcode() {
        new daum.Postcode({ oncomplete: function(data) {
            document.getElementById("address").value = data.roadAddress || data.jibunAddress;
        }}).open();
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw", authDomain: "edumaker-teacher-d97ba.firebaseapp.com", projectId: "edumaker-teacher-d97ba", storageBucket: "edumaker-teacher-d97ba.firebasestorage.app", messagingSenderId: "532708143359", appId: "1:532708143359:web:89b9933da4c868127ddcca", measurementId: "G-JJ1TF77VBJ" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('id');

    let originalData = {}; 

    function createHourOptions(selected) {
        let options = ''; for(let i=1; i<=12; i++) { let val = i.toString().padStart(2, '0'); options += `<option value="${val}" ${val === selected ? 'selected' : ''}>${val}</option>`; } return options;
    }
    function createMinuteOptions(selected) {
        let options = ''; for(let i=0; i<60; i+=5) { let val = i.toString().padStart(2, '0'); options += `<option value="${val}" ${val === selected ? 'selected' : ''}>${val}</option>`; } return options;
    }

    window.addScheduleRow = function(dateValue = '', timeString = '') {
        const container = document.getElementById('scheduleContainer');
        const row = document.createElement('div');
        row.className = 'schedule-row';
        let t = { sAmpm: 'ì˜¤í›„', sH: '02', sM: '00', eAmpm: 'ì˜¤í›„', eH: '04', eM: '00' };
        if(timeString) {
            try {
                const parts = timeString.split(' ~ ');
                const start = parts[0].split(' '); const end = parts[1].split(' ');
                t.sAmpm = start[0]; t.sH = start[1].split(':')[0]; t.sM = start[1].split(':')[1];
                t.eAmpm = end[0]; t.eH = end[1].split(':')[0]; t.eM = end[1].split(':')[1];
            } catch(e) {}
        }
        
        row.innerHTML = `
            <input type="date" class="input-date" value="${dateValue}">
            <div class="time-picker-group">
                <div class="time-set">
                    <select class="ampm-start ampm-select"><option value="ì˜¤ì „" ${t.sAmpm==='ì˜¤ì „'?'selected':''}>ì˜¤ì „</option><option value="ì˜¤í›„" ${t.sAmpm==='ì˜¤í›„'?'selected':''}>ì˜¤í›„</option></select>
                    <select class="hour-start hour-select">${createHourOptions(t.sH)}</select>
                    <span>:</span>
                    <select class="min-start min-select">${createMinuteOptions(t.sM)}</select>
                </div>
                <span class="tilde">~</span>
                <div class="time-set">
                    <select class="ampm-end ampm-select"><option value="ì˜¤ì „" ${t.eAmpm==='ì˜¤ì „'?'selected':''}>ì˜¤ì „</option><option value="ì˜¤í›„" ${t.eAmpm==='ì˜¤í›„'?'selected':''}>ì˜¤í›„</option></select>
                    <select class="hour-end hour-select">${createHourOptions(t.eH)}</select>
                    <span>:</span>
                    <select class="min-end min-select">${createMinuteOptions(t.eM)}</select>
                </div>
            </div>
            <button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">-</button>`;
        container.appendChild(row);
    }

    if (docId) {
        getDoc(doc(db, "assignments", docId)).then((docSnap) => {
            if (docSnap.exists()) {
                originalData = docSnap.data(); 
                document.getElementById('teacherName').value = originalData.teacherName;
                document.getElementById('teacherEmail').value = originalData.teacherEmail;
                document.getElementById('phone').value = originalData.phone || '';
                document.getElementById('client').value = originalData.client;
                document.getElementById('subject').value = originalData.subject;
                document.getElementById('address').value = originalData.address;
                document.getElementById('requestClient').value = originalData.requestClient || ''; 
                document.getElementById('classHours').value = originalData.classHours;
                document.getElementById('hourlyRate').value = Number(originalData.hourlyRate).toLocaleString();
                document.getElementById('originalFee').value = Number(originalData.originalFee || 0).toLocaleString(); // âœ… ì›ì‹œê¸‰ ë¡œë“œ
                document.getElementById('additionalCost').value = Number(originalData.additionalCost || 0).toLocaleString();
                document.getElementById('commissionRate').value = originalData.commissionRate || 0;
                document.getElementById('note').value = originalData.note || '';

                if (["ì£¼ê°•ì‚¬", "ë³´ì¡°ê°•ì‚¬", "ì•ˆì „ìš”ì›"].includes(originalData.role)) document.getElementById('roleSelect').value = originalData.role;
                else if(originalData.role) { document.getElementById('roleSelect').value = "direct"; document.getElementById('roleInputDirect').style.display='block'; document.getElementById('roleInputDirect').value=originalData.role; }
                const dates = originalData.date ? originalData.date.split(', ') : [];
                const times = originalData.time ? originalData.time.split(', ') : [];
                if(dates.length > 0) dates.forEach((d, i) => addScheduleRow(d, times[i]));
                else addScheduleRow();
            }
        });
    }

    document.getElementById('roleSelect').addEventListener('change', function() {
        const dInput = document.getElementById('roleInputDirect');
        if(this.value === 'direct') { dInput.style.display = 'block'; dInput.focus(); }
        else { dInput.style.display = 'none'; dInput.value = ''; }
    });

    function handleComma(e) { let v = e.target.value.replace(/[^0-9]/g, ''); e.target.value = v ? Number(v).toLocaleString() : ''; }
    document.getElementById('hourlyRate').addEventListener('input', handleComma);
    document.getElementById('originalFee').addEventListener('input', handleComma); // âœ… ì›ì‹œê¸‰ ì½¤ë§ˆ ì²˜ë¦¬
    document.getElementById('additionalCost').addEventListener('input', handleComma);
    document.getElementById('addScheduleBtn').onclick = () => addScheduleRow();

    document.getElementById('updateBtn').onclick = async () => {
        const btn = document.getElementById('updateBtn');
        const phone = document.getElementById('phone').value.trim();
        const reqClient = document.getElementById('requestClient').value.trim();
        const origFee = Number(document.getElementById('originalFee').value.replace(/,/g, '')) || 0; // âœ… ì›ì‹œê¸‰ ìˆ«ì ë³€í™˜
        
        const rows = document.querySelectorAll('.schedule-row');
        let dList = []; let tList = [];
        rows.forEach(row => {
            const d = row.querySelector('.input-date').value;
            const ts = `${row.querySelector('.ampm-start').value} ${row.querySelector('.hour-start').value}:${row.querySelector('.min-start').value}`;
            const te = `${row.querySelector('.ampm-end').value} ${row.querySelector('.hour-end').value}:${row.querySelector('.min-end').value}`;
            if(d) { dList.push(d); tList.push(`${ts} ~ ${te}`); }
        });

        btn.disabled = true;
        btn.innerText = "ì €ì¥ ì¤‘...";

        try {
            const classHours = Number(document.getElementById('classHours').value);
            const hourlyRate = Number(document.getElementById('hourlyRate').value.replace(/,/g, ''));
            const commRate = Number(document.getElementById('commissionRate').value);

            await updateDoc(doc(db, "assignments", docId), {
                phone: phone, 
                requestClient: reqClient,
                originalFee: origFee, // âœ… ì›ì‹œê¸‰ ì—…ë°ì´íŠ¸
                client: document.getElementById('client').value.trim(),
                subject: document.getElementById('subject').value.trim(),
                address: document.getElementById('address').value.trim(),
                role: document.getElementById('roleSelect').value === 'direct' ? document.getElementById('roleInputDirect').value : document.getElementById('roleSelect').value,
                date: dList.join(', '), time: tList.join(', '),
                classHours: classHours,
                hourlyRate: hourlyRate,
                additionalCost: Number(document.getElementById('additionalCost').value.replace(/,/g, '')),
                commissionRate: commRate,
                serviceFee: Math.floor((classHours * hourlyRate) * (commRate / 100)),
                note: document.getElementById('note').value.trim(),
                isUpdated: true, status: "ë°°ì •ì™„ë£Œ"
            });
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); window.close(); 
        } catch (e) { alert("ì˜¤ë¥˜: " + e.message); btn.disabled = false; btn.innerText = "ìˆ˜ì • ë‚´ìš© ì €ì¥í•˜ê¸°"; }
    };
</script>
</body>
</html>