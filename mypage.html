<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì •ë³´ ìˆ˜ì • - EDUMAKER</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f4f7f9; padding: 20px; margin: 0; }
        .edit-container { 
            background: #fff; padding: 35px; border-radius: 16px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.05); 
            max-width: 500px; margin: 20px auto; 
        }
        .header-title { 
            font-size: 22px; font-weight: 800; color: #0056b3; 
            text-align: center; margin-bottom: 30px; border-bottom: 2px solid #0056b3; padding-bottom: 15px;
        }
        
        .input-group { margin-bottom: 18px; }
        label { display: block; font-size: 13px; font-weight: 600; color: #444; margin-bottom: 6px; }
        
        input[readonly] { background-color: #f1f3f5; color: #6c757d; cursor: not-allowed; }
        
        input { 
            width: 100%; padding: 12px; border: 1px solid #ddd; 
            border-radius: 8px; box-sizing: border-box; font-size: 16px; 
        }
        
        /* ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì•ˆë‚´ */
        .pw-guide { font-size: 12px; color: #d93025; margin-top: 5px; margin-bottom: 5px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 30px; }
        .btn-save { flex: 2; padding: 15px; background-color: #0056b3; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; }
        .btn-cancel { flex: 1; padding: 15px; background-color: #6c757d; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; }
        
        .btn-save:hover { background-color: #004494; }
        .btn-cancel:hover { background-color: #5a6268; }
    </style>
</head>
<body>

<div class="edit-container">
    <div class="header-title">ğŸ§‘â€ğŸ« ë‚´ ì •ë³´ ìˆ˜ì •</div>
    
    <div class="input-group">
        <label>ì´ë¦„ (ìˆ˜ì •ë¶ˆê°€)</label>
        <input type="text" id="name" readonly>
    </div>

    <div class="input-group">
        <label>ì´ë©”ì¼ (ì•„ì´ë”” / ìˆ˜ì •ë¶ˆê°€)</label>
        <input type="text" id="email" readonly>
    </div>

    <div class="input-group">
        <label>ì „í™”ë²ˆí˜¸ (ìˆ˜ì •ë¶ˆê°€)</label>
        <input type="text" id="phone" readonly>
    </div>

    <div class="input-group">
        <label>ğŸ“ í™œë™ì§€ì—­ (ìˆ˜ì •ê°€ëŠ¥)</label>
        <input type="text" id="region" placeholder="ì˜ˆ: ì„œìš¸ ê°•ë‚¨êµ¬">
    </div>

    <hr style="margin: 25px 0; border: 0; border-top: 1px dashed #ddd;">

    <div class="input-group">
        <label>ğŸ”’ ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½ì‹œì—ë§Œ ì…ë ¥)</label>
        <input type="password" id="newPassword" placeholder="ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)">
        <p class="pw-guide">â€» ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”.</p>
    </div>

    <div class="input-group">
        <label>ğŸ”’ ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
        <input type="password" id="newPasswordConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥">
    </div>

    <div class="btn-group">
        <button class="btn-cancel" onclick="history.back()">ì·¨ì†Œ</button>
        <button class="btn-save" id="saveBtn">ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw",
        authDomain: "edumaker-teacher-d97ba.firebaseapp.com",
        projectId: "edumaker-teacher-d97ba",
        storageBucket: "edumaker-teacher-d97ba.firebasestorage.app",
        messagingSenderId: "532708143359",
        appId: "1:532708143359:web:89b9933da4c868127ddcca",
        measurementId: "G-JJ1TF77VBJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // 1. ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì •ë³´ ë¡œë“œ
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            try {
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('name').value = data.name || '';
                    document.getElementById('email').value = data.email || user.email;
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('region').value = data.region || '';
                }
            } catch (e) {
                alert("ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        } else {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = "index.html";
        }
    });

    // 2. ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
    document.getElementById('saveBtn').addEventListener('click', async () => {
        if (!currentUser) return;

        const newRegion = document.getElementById('region').value.trim();
        const newPw = document.getElementById('newPassword').value;
        const newPwConfirm = document.getElementById('newPasswordConfirm').value;

        if (!newRegion) {
            alert("í™œë™ì§€ì—­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerText = "ì €ì¥ ì¤‘...";

        try {
            await updateDoc(doc(db, "users", currentUser.uid), {
                region: newRegion
            });

            if (newPw) {
                if (newPw.length < 6) {
                    alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                    btn.disabled = false; btn.innerText = "ì €ì¥í•˜ê¸°";
                    return;
                }
                if (newPw !== newPwConfirm) {
                    alert("ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    btn.disabled = false; btn.innerText = "ì €ì¥í•˜ê¸°";
                    return;
                }

                await updatePassword(currentUser, newPw);
                alert("ì •ë³´ ìˆ˜ì • ë° ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                location.href = "index.html"; 
                return;
            }

            alert("ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.href = "teacher_main.html"; 

        } catch (error) {
            console.error(error);
            if (error.code === 'auth/requires-recent-login') {
                alert("ë³´ì•ˆì„ ìœ„í•´ ë‹¤ì‹œ ë¡œê·¸ì¸í•œ í›„ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.");
                location.href = "index.html";
            } else {
                alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
                btn.disabled = false; 
                btn.innerText = "ì €ì¥í•˜ê¸°";
            }
        }
    });
</script>
</body>
</html>