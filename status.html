<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—ë“€ë©”ì´ì»¤ - ë°°ì • í˜„í™© ë° ì •ì‚° ê´€ë¦¬</title>
    <style>
        /* ê¸°ë³¸ ë°°ê²½: ëˆˆì´ í¸ì•ˆí•œ ìƒ‰ìƒ */
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; padding: 40px; margin: 0; }
        
        .list-container { max-width: 1650px; margin: 0 auto; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f5; padding-bottom: 20px; }
        .logo { font-size: 24px; font-weight: 800; color: #0056b3; cursor: pointer; text-decoration: none; }
        h2 { color: #1a1a1a; margin: 0; font-size: 20px; }
        
        .filter-bar { margin-bottom: 20px; display: flex; align-items: center; gap: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; }
        .filter-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .filter-bar select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ced4da; font-size: 13px; background-color: white; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; border-top: 2px solid #0056b3; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; font-size: 13px; vertical-align: middle; }
        th { background-color: #fafafa; color: #495057; font-weight: 700; font-size: 12px; line-height: 1.4; text-align: center; }

        /* ì»¬ëŸ¼ ë„ˆë¹„ ë° ì—¬ë°± ì •ë°€ ì¡°ì • */
        .col-date { width: 125px; text-align: center; }
        .col-user { width: 150px; text-align: center; }
        
        /* ğŸ”¥ [ìˆ˜ì •] ê°•ì˜ì²˜ ì˜ì—­: ì™¼ìª½ ì—¬ë°±(padding-left)ì„ 35pxë¡œ ëŠ˜ë ¤ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë” ì´ë™ */
        .col-info { width: 200px; padding-left: 35px !important; } 
        
        .col-pay { width: 115px; text-align: right; padding-right: 15px !important; }
        .col-total { width: 115px; text-align: right; padding-right: 15px !important; }
        
        /* ë¹„ê³ ë€: ê°€ë¡œ ìŠ¤í¬ë¡¤ ì œê±° ë° ì˜¤ë¥¸ìª½ ì„¸ë¡œ ìŠ¤í¬ë¡¤ ê³ ì • */
        .col-note { width: 140px; }
        .note-content { 
            font-size: 11px; 
            color: #666; 
            line-height: 1.4; 
            max-height: 65px; 
            overflow-y: auto; 
            overflow-x: hidden; 
            word-break: break-all; 
            white-space: normal; 
            padding-right: 5px;
        }

        .col-confirm { width: 70px; text-align: center; }
        .col-chk { width: 130px; }
        .col-manage { width: 140px; text-align: center; }

        /* ì™„ë£Œ ì‹œ ì—°í•œ ë…¸ë€ìƒ‰ ë°°ê²½ìƒ‰ ì ìš© */
        .row-finished, .row-finished td { background-color: #fffde7 !important; }

        /* í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ë§ */
        .text-line { display: block; margin-bottom: 2px; line-height: 1.3; }
        .text-main { font-weight: 600; color: #333; }
        .text-sub { font-size: 11.5px; color: #666; }
        .text-blue { color: #0056b3; font-weight: 600; }
        .text-red { color: #d93025; font-weight: 700; font-size: 14px; }
        .text-green { color: #28a745; font-size: 11px; font-weight: 600; }

        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; }
        .status-wait { background: #fff3cd; color: #856404; }
        .status-ok { background: #d4edda; color: #155724; }
        
        .chk-group { display: flex; flex-direction: column; gap: 5px; font-size: 11.5px; }
        .chk-group label { display: flex; align-items: center; cursor: pointer; white-space: nowrap; }
        .chk-group input { margin-right: 6px; transform: scale(1.05); }

        /* ê´€ë¦¬ ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 4px; flex-wrap: wrap; }
        .btn-group button { border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; padding: 6px 0; color: white; }
        .btn-half { flex: 0 0 calc(50% - 2px); }
        .btn-full { flex: 0 0 100%; margin-top: 2px; }
        
        .btn-finish { background-color: #555e67; }
        .btn-restore { background-color: #28a745; }
        .btn-edit { background-color: #0056b3; }
        .btn-delete { background-color: #ff4d4f; }

        .btn-back { background-color: #0056b3; color: white; text-decoration: none; padding: 10px 22px; border-radius: 8px; font-size: 14px; font-weight: 600; transition: background 0.2s; }
        .btn-back:hover { background-color: #004494; }
    </style>
</head>
<body>

<div class="list-container">
    <div class="header">
        <a href="admin.html" class="logo">EDUMAKER ADMIN</a>
        <h2>ğŸ“‹ ë°°ì • í˜„í™© ë° ì •ì‚° ê´€ë¦¬</h2>
        <a href="admin.html" class="btn-back">ê°•ì˜ ë°°ì • í˜ì´ì§€ë¡œ</a>
    </div>
    
    <div class="filter-bar">
        <div class="filter-item"><strong>ğŸ” ê°•ì‚¬ í•„í„° :</strong><select id="teacherFilter" onchange="filterAssignments()"><option value="all">ì „ì²´ ê°•ì‚¬</option></select></div>
        <div class="filter-item"><strong>ğŸ« ê°•ì˜ì²˜ í•„í„° :</strong><select id="clientFilter" onchange="filterAssignments()"><option value="all">ì „ì²´ ê°•ì˜ì²˜</option></select></div>
    </div>

    <table>
        <thead>
            <tr>
                <th class="col-date">êµìœ¡ì¼ì/ì‹œê°„</th>
                <th class="col-user">ì´ë¦„/ì´ë©”ì¼</th>
                <th class="col-info">ê°•ì˜ì²˜ / ê°•ì¢Œëª… / ì—­í• </th>
                <th class="col-pay">ì‹œê°„ / ì‹œê¸‰ / ì¶”ê°€</th>
                <th class="col-total">ì„œë¹„ìŠ¤ / ìˆ˜ìˆ˜ë£Œ / í•©ê³„</th>
                <th class="col-note">ë¹„ê³ </th>
                <th class="col-confirm">í™•ì¸</th>
                <th class="col-chk">ì •ì‚° ì²˜ë¦¬</th>
                <th class="col-manage">ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="admin-list-body">
            <tr><td colspan="9" style="text-align:center; padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
        </tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw", authDomain: "edumaker-teacher-d97ba.firebaseapp.com", projectId: "edumaker-teacher-d97ba", storageBucket: "edumaker-teacher-d97ba.firebasestorage.app", messagingSenderId: "532708143359", appId: "1:532708143359:web:89b9933da4c868127ddcca", measurementId: "G-JJ1TF77VBJ" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    let allAssignments = [];

    window.updatePayStatus = async function(docId, field, isChecked) {
        try { await updateDoc(doc(db, "assignments", docId), { [field]: isChecked }); } catch (error) { alert("ì‹¤íŒ¨"); }
    }

    window.toggleFinishStatus = async function(docId, currentStatus) {
        const msg = currentStatus ? "ë‹¤ì‹œ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ê°•ì˜ì™€ ì •ì‚°ì´ ëª¨ë‘ ëë‚¬ìŠµë‹ˆê¹Œ?\nì™„ë£Œ ì‹œ ë°°ê²½ì´ ì—°í•œ ë…¸ë€ìƒ‰ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.";
        if(!confirm(msg)) return;
        try { await updateDoc(doc(db, "assignments", docId), { isFinished: !currentStatus }); } catch (error) { alert("ë³€ê²½ ì‹¤íŒ¨"); }
    }

    window.editAssignment = function(docId) {
        window.open(`edit.html?id=${docId}`, 'edit', 'width=750,height=850,scrollbars=yes');
    }

    window.deleteAssignment = async function(docId, subject, teacher) {
        if (!confirm(`[ì‚­ì œ í™•ì¸] ${teacher} ê°•ì‚¬ë‹˜ì˜ ${subject} ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try { await deleteDoc(doc(db, "assignments", docId)); } catch (error) { alert("ì‚­ì œ ì‹¤íŒ¨"); }
    }

    function renderList(dataList) {
        const listBody = document.getElementById('admin-list-body');
        let html = "";
        dataList.forEach((item) => {
            const data = item.data;
            const isFinished = data.isFinished || false;
            const totalPay = (Number(data.classHours || 0) * Number(data.hourlyRate || 0)) + Number(data.additionalCost || 0);
            const isConfirmed = data.status === 'í™•ì¸ì™„ë£Œ';

            let schHtml = "";
            (data.date || "").split(', ').forEach((d, i) => {
                schHtml += `<div style="margin-bottom:3px;"><b style="color:#333;">${d}</b><br><span style="color:#0056b3; font-size:11px;">${(data.time||"").split(', ')[i]||''}</span></div>`;
            });

            html += `
                <tr class="${isFinished ? 'row-finished' : ''}">
                    <td class="col-date">${schHtml}</td>
                    <td class="col-user"><span class="text-main">${data.teacherName}</span><br><span class="text-sub">${data.teacherEmail}</span></td>
                    <td class="col-info">
                        <span class="text-line"><b style="color:#0056b3;">${data.client}</b></span>
                        <span class="text-line">${data.subject}</span>
                        <span class="text-line text-sub">ì—­í• : ${data.role || 'ê°•ì‚¬'}</span>
                    </td>
                    <td class="col-pay">
                        <span class="text-line">${data.classHours}ì‹œê°„</span>
                        <span class="text-line text-sub">${Number(data.hourlyRate).toLocaleString()}ì›</span>
                        <span class="text-line text-green">${data.additionalCost > 0 ? '+' + Number(data.additionalCost).toLocaleString() : ''}</span>
                    </td>
                    <td class="col-total">
                        <span class="text-line">${(data.serviceFee || 0).toLocaleString()}ì›</span>
                        <span class="text-line text-sub">(${data.commissionRate}%)</span>
                        <span class="text-line text-red">${totalPay.toLocaleString()}ì›</span>
                    </td>
                    <td class="col-note">
                        <div class="note-content">${data.note || '-'}</div>
                    </td>
                    <td class="col-confirm"><span class="status-badge ${isConfirmed ? 'status-ok' : 'status-wait'}">${isConfirmed ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}</span></td>
                    <td class="col-chk">
                        <div class="chk-group">
                            <label><input type="checkbox" ${data.isPaidTeacher ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidTeacher', this.checked)"> ê°•ì‚¬ë£Œì™„ë£Œ</label>
                            <label><input type="checkbox" ${data.isPaidService ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidService', this.checked)"> ì„œë¹„ìŠ¤ë£Œí™•ì¸</label>
                        </div>
                    </td>
                    <td class="col-manage">
                        <div class="btn-group">
                            <button class="btn-half ${isFinished ? 'btn-restore' : 'btn-finish'}" onclick="toggleFinishStatus('${item.id}', ${isFinished})">${isFinished ? 'ë³µêµ¬' : 'ì™„ë£Œ'}</button>
                            <button class="btn-half btn-edit" onclick="editAssignment('${item.id}')">ìˆ˜ì •</button>
                            <button class="btn-full btn-delete" onclick="deleteAssignment('${item.id}', '${data.subject}', '${data.teacherName}')">ë‚´ì—­ì‚­ì œ</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        listBody.innerHTML = html || '<tr><td colspan="9" style="text-align:center; padding:30px;">ë‚´ì—­ ì—†ìŒ</td></tr>';
    }

    onSnapshot(query(collection(db, "assignments"), orderBy("createdAt", "desc"), limit(100)), (sn) => {
        allAssignments = sn.docs.map(d => ({ id: d.id, data: d.data() }));
        const tSet = new Set(); const cSet = new Set();
        allAssignments.forEach(i => { if(i.data.teacherName) tSet.add(i.data.teacherName); if(i.data.client) cSet.add(i.data.client); });
        document.getElementById('teacherFilter').innerHTML = `<option value="all">ì „ì²´ ê°•ì‚¬</option>` + Array.from(tSet).map(t => `<option value="${t}">${t}</option>`).join('');
        document.getElementById('clientFilter').innerHTML = `<option value="all">ì „ì²´ ê°•ì˜ì²˜</option>` + Array.from(cSet).map(c => `<option value="${c}">${c}</option>`).join('');
        renderList(allAssignments);
    });

    window.filterAssignments = () => {
        const t = document.getElementById('teacherFilter').value;
        const c = document.getElementById('clientFilter').value;
        const filtered = allAssignments.filter(i => (t === "all" || i.data.teacherName === t) && (c === "all" || i.data.client === c));
        renderList(filtered);
    }
</script>
</body>
</html>