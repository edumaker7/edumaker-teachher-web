<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë“€ë©”ì´ì»¤ - ë°°ì • í˜„í™© ë° ì •ì‚° ê´€ë¦¬</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; padding: 40px; margin: 0; }
        
        .list-container { max-width: 1650px; margin: 0 auto; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f5; padding-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .logo { font-size: 24px; font-weight: 800; color: #0056b3; cursor: pointer; text-decoration: none; }
        h2 { color: #1a1a1a; margin: 0; font-size: 20px; }
        
        .filter-bar { margin-bottom: 20px; display: flex; align-items: center; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; flex-wrap: wrap; }
        .filter-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .filter-bar select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ced4da; font-size: 13px; background-color: white; }
        
        .filter-bar input[type="date"] { padding: 7px 10px; border-radius: 6px; border: 1px solid #ced4da; font-size: 13px; font-family: inherit; }
        
        .btn-search { background-color: #0056b3; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-search:hover { background-color: #004494; }
        .btn-reset { background-color: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-reset:hover { background-color: #5a6268; }

        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-bottom: 1px solid #eee; }
        table { width: 100%; min-width: 1200px; border-collapse: collapse; table-layout: fixed; border-top: 2px solid #0056b3; }
        
        th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; font-size: 13px; vertical-align: middle; }
        th { background-color: #fafafa; color: #495057; font-weight: 700; font-size: 12px; line-height: 1.4; text-align: center; }

        .col-no { width: 45px; text-align: center; font-weight: bold; color: #666; }
        .col-date { width: 115px; text-align: center; }
        .col-user { width: 160px; text-align: center; }
        .col-info { width: 200px; padding-left: 20px !important; } 
        .col-pay { width: 105px; text-align: right; padding-right: 15px !important; }
        .col-total { width: 125px; text-align: right; padding-right: 15px !important; }
        .col-note { width: 170px; }
        .note-content { 
            font-size: 11px; color: #666; line-height: 1.4; 
            max-height: 65px; overflow-y: auto; overflow-x: hidden; 
            word-break: break-all; white-space: normal; padding-right: 5px;
        }
        .col-confirm { width: 70px; text-align: center; }
        .col-chk { width: 130px; }
        .col-manage { width: 110px; text-align: center; padding-right: 4px; }

        .row-finished, .row-finished td { background-color: #fffde7 !important; }

        .summary-bar {
            margin-top: 20px;
            background-color: #e3f2fd;
            border: 2px solid #0056b3;
            border-radius: 12px;
            padding: 20px 30px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 40px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .sum-item { display: flex; align-items: center; gap: 10px; font-size: 15px; color: #333; }
        .sum-label { font-weight: 600; color: #555; }
        .sum-value { font-size: 18px; font-weight: 800; color: #0056b3; letter-spacing: -0.5px; }
        .sum-value.highlight { color: #d93025; font-size: 22px; }
        
        .sum-divider { width: 1px; height: 18px; background-color: #cbd5e1; }

        @media (max-width: 768px) {
            body { padding: 15px; }
            .list-container { padding: 15px; }
            .summary-bar { flex-direction: column; align-items: flex-start; gap: 15px; padding: 20px; }
            .sum-item { width: 100%; justify-content: space-between; }
            .sum-divider { display: none; }
            .header { flex-direction: column; align-items: flex-start; }
            .btn-back { width: 100%; text-align: center; box-sizing: border-box; }
            .filter-bar { gap: 10px; }
        }

        .text-line { 
            display: block; 
            margin-bottom: 3px; 
            line-height: 1.4; 
            white-space: normal; 
            word-break: keep-all; 
        }
        
        .text-main { font-weight: 600; color: #333; }
        .text-sub { font-size: 11.5px; color: #666; }
        .text-client { font-size: 11.5px; color: #6741d9; font-weight: 600; margin-top: 2px; }

        .text-green { color: #28a745; font-size: 11px; font-weight: 600; }
        .text-blue { color: #0056b3; font-weight: 700; font-size: 13px; }
        .text-red { color: #d93025; font-weight: 700; font-size: 14px; }

        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; }
        .status-wait { background: #fff3cd; color: #856404; }
        .status-ok { background: #d4edda; color: #155724; }
        
        .chk-group { display: flex; flex-direction: column; gap: 5px; font-size: 11.5px; }
        .chk-group label { display: flex; align-items: center; cursor: pointer; white-space: nowrap; }
        .chk-group input { margin-right: 6px; transform: scale(1.05); }

        .btn-group { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
        
        .btn-group button { 
            border: none; border-radius: 4px; cursor: pointer; 
            font-size: 11px; font-weight: bold; padding: 6px 0; 
            color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
        }
        
        .btn-half { flex: 1; min-width: 40px; }
        .btn-full { width: 100%; margin-top: 2px; }
        
        .btn-finish { background-color: #555e67; }
        .btn-restore { background-color: #28a745; }
        .btn-edit { background-color: #0056b3; }
        .btn-delete { background-color: #ff4d4f; }
        .btn-back { background-color: #0056b3; color: white; text-decoration: none; padding: 10px 22px; border-radius: 8px; font-size: 14px; font-weight: 600; transition: background 0.2s; }
        .btn-back:hover { background-color: #004494; }
    </style>
</head>
<body>

<div class="list-container">
    <div class="header">
        <div style="display:flex; align-items:center; gap:10px;">
            <a href="admin.html" class="logo">EDUMAKER ADMIN</a>
            <h2>ğŸ“‹ ë°°ì • í˜„í™©</h2>
        </div>
        <a href="admin.html" class="btn-back">ê°•ì˜ ë°°ì • í˜ì´ì§€ë¡œ</a>
    </div>
    
    <div class="filter-bar">
        <div class="filter-item"><strong>ğŸ” ê°•ì‚¬ :</strong><select id="teacherFilter" onchange="filterAssignments()"><option value="all">ì „ì²´</option></select></div>
        <div class="filter-item"><strong>ğŸ« ê°•ì˜ì²˜ :</strong><select id="clientFilter" onchange="filterAssignments()"><option value="all">ì „ì²´</option></select></div>
        <div class="filter-item"><strong>ğŸ›ï¸ ì˜ë¢°ì²˜ :</strong><select id="requestClientFilter" onchange="filterAssignments()"><option value="all">ì „ì²´</option></select></div>
        
        <div class="filter-item"><strong>âœ… í™•ì¸ :</strong>
            <select id="confirmFilter" onchange="filterAssignments()">
                <option value="all">ì „ì²´</option>
                <option value="confirmed">í™•ì¸ì™„ë£Œ</option>
                <option value="pending">í™•ì¸ëŒ€ê¸°</option>
            </select>
        </div>
        
        <div class="filter-item" style="margin-left:auto; display:flex; align-items:center; gap:5px;">
            <strong>ğŸ“… ê¸°ê°„ :</strong>
            <input type="date" id="startDate"> ~ <input type="date" id="endDate">
            <button class="btn-search" onclick="filterAssignments()">ì¡°íšŒ</button>
            <button class="btn-reset" onclick="resetFilters()">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th class="col-no">No</th>
                    <th class="col-date">êµìœ¡ì¼ì/ì‹œê°„</th>
                    <th class="col-user">ì´ë¦„/ì´ë©”ì¼/ì˜ë¢°ì²˜</th>
                    <th class="col-info">ê°•ì˜ì²˜ / ê°•ì¢Œëª… / ì—­í• </th>
                    <th class="col-pay">ì‹œê°„ / ì‹œê¸‰ / ì¶”ê°€</th>
                    <th class="col-total">ì„œë¹„ìŠ¤ / ìˆ˜ìˆ˜ë£Œ / í•©ê³„</th>
                    <th class="col-note">ë¹„ê³ </th>
                    <th class="col-confirm">í™•ì¸</th>
                    <th class="col-chk">ì •ì‚° ì²˜ë¦¬</th>
                    <th class="col-manage">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="admin-list-body">
                <tr><td colspan="10" style="text-align:center; padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="summary-container"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw", authDomain: "edumaker-teacher-d97ba.firebaseapp.com", projectId: "edumaker-teacher-d97ba", storageBucket: "edumaker-teacher-d97ba.firebasestorage.app", messagingSenderId: "532708143359", appId: "1:532708143359:web:89b9933da4c868127ddcca", measurementId: "G-JJ1TF77VBJ" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    let allAssignments = [];

    window.updatePayStatus = async function(docId, field, isChecked) {
        try { await updateDoc(doc(db, "assignments", docId), { [field]: isChecked }); } catch (error) { alert("ì‹¤íŒ¨"); }
    }

    window.toggleFinishStatus = async function(docId, currentStatus) {
        if(!confirm(currentStatus ? "ë‹¤ì‹œ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try { await updateDoc(doc(db, "assignments", docId), { isFinished: !currentStatus }); } catch (error) { alert("ë³€ê²½ ì‹¤íŒ¨"); }
    }

    window.editAssignment = function(docId) {
        window.open(`edit.html?id=${docId}`, 'edit', 'width=750,height=850,scrollbars=yes');
    }

    window.deleteAssignment = async function(docId, subject, teacher) {
        if (!confirm(`[ì‚­ì œ í™•ì¸] ${teacher} ê°•ì‚¬ë‹˜ì˜ ${subject} ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try { await deleteDoc(doc(db, "assignments", docId)); } catch (error) { alert("ì‚­ì œ ì‹¤íŒ¨"); }
    }

    function renderList(dataList) {
        const listBody = document.getElementById('admin-list-body');
        const summaryCon = document.getElementById('summary-container');
        let html = "";
        
        let sumServiceFee = 0;
        let sumGrandTotal = 0;
        const totalCount = dataList.length;

        dataList.forEach((item, index) => {
            const data = item.data;
            const isFinished = data.isFinished || false;
            const fee = Number(data.classHours || 0) * Number(data.hourlyRate || 0);
            const totalPay = fee + Number(data.additionalCost || 0);
            const serviceFee = Number(data.serviceFee || 0);
            const isConfirmed = data.status === 'í™•ì¸ì™„ë£Œ';

            sumServiceFee += serviceFee;
            sumGrandTotal += totalPay;

            let schHtml = "";
            (data.date || "").split(', ').forEach((d, i) => {
                schHtml += `<div style="margin-bottom:3px;"><b style="color:#333;">${d}</b><br><span style="color:#0056b3; font-size:11px;">${(data.time||"").split(', ')[i]||''}</span></div>`;
            });

            html += `
                <tr class="${isFinished ? 'row-finished' : ''}">
                    <td class="col-no">${index + 1}</td>
                    <td class="col-date">${schHtml}</td>
                    <td class="col-user">
                        <span class="text-main">${data.teacherName}</span><br>
                        <span class="text-sub">${data.teacherEmail}</span><br>
                        <span class="text-client">${data.requestClient || '-'}</span>
                    </td>
                    <td class="col-info">
                        <span class="text-line"><b style="color:#0056b3;">${data.client}</b></span>
                        <span class="text-line">${data.subject}</span>
                        <span class="text-line text-sub">ì—­í• : ${data.role || 'ê°•ì‚¬'}</span>
                    </td>
                    <td class="col-pay">
                        <span class="text-line">${data.classHours}ì‹œê°„</span>
                        <span class="text-line text-sub">${Number(data.hourlyRate).toLocaleString()}ì›</span>
                        <span class="text-line text-green">${data.additionalCost > 0 ? '+' + Number(data.additionalCost).toLocaleString() : ''}</span>
                    </td>
                    <td class="col-total">
                        <span class="text-line text-blue">${serviceFee.toLocaleString()}ì›</span>
                        <span class="text-line text-sub">(${data.commissionRate}%)</span>
                        <span class="text-line text-red">${totalPay.toLocaleString()}ì›</span>
                    </td>
                    <td class="col-note"><div class="note-content">${data.note || '-'}</div></td>
                    <td class="col-confirm"><span class="status-badge ${isConfirmed ? 'status-ok' : 'status-wait'}">${isConfirmed ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}</span></td>
                    <td class="col-chk">
                        <div class="chk-group">
                            <label><input type="checkbox" ${data.isPaidTeacher ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidTeacher', this.checked)"> ê°•ì‚¬ë£Œì™„ë£Œ</label>
                            <label><input type="checkbox" ${data.isPaidService ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidService', this.checked)"> ì„œë¹„ìŠ¤ë£Œí™•ì¸</label>
                        </div>
                    </td>
                    <td class="col-manage">
                        <div class="btn-group">
                            <button class="btn-half ${isFinished ? 'btn-restore' : 'btn-finish'}" onclick="toggleFinishStatus('${item.id}', ${isFinished})">${isFinished ? 'ë³µêµ¬' : 'ì™„ë£Œ'}</button>
                            <button class="btn-half btn-edit" onclick="editAssignment('${item.id}')">ìˆ˜ì •</button>
                            <button class="btn-full btn-delete" onclick="deleteAssignment('${item.id}', '${data.subject}', '${data.teacherName}')">ë‚´ì—­ì‚­ì œ</button>
                        </div>
                    </td>
                </tr>
            `;
        });

        listBody.innerHTML = html || '<tr><td colspan="10" style="text-align:center; padding:40px;">ë‚´ì—­ ì—†ìŒ</td></tr>';

        if (totalCount > 0) {
            summaryCon.innerHTML = `
                <div class="summary-bar">
                    <div class="sum-item">
                        <span class="sum-label">ì´ ë°°ì • ê°•ì˜</span>
                        <span class="sum-value">${totalCount}ê±´</span>
                    </div>
                    <div class="sum-divider"></div>
                    <div class="sum-item">
                        <span class="sum-label">ì„œë¹„ìŠ¤ ì´ìš©ë£Œ í•©ê³„</span>
                        <span class="sum-value">${sumServiceFee.toLocaleString()}ì›</span>
                    </div>
                    <div class="sum-divider"></div>
                    <div class="sum-item">
                        <span class="sum-label">ì´ ë§¤ì¶œ í•©ê³„</span>
                        <span class="sum-value highlight">${sumGrandTotal.toLocaleString()}ì›</span>
                    </div>
                </div>
            `;
        } else {
            summaryCon.innerHTML = "";
        }
    }

    onSnapshot(query(collection(db, "assignments"), orderBy("createdAt", "desc"), limit(200)), (sn) => {
        allAssignments = sn.docs.map(d => ({ id: d.id, data: d.data() }));
        
        const tSet = new Set(); const cSet = new Set();
        const rSet = new Set(); 

        allAssignments.forEach(i => { 
            if(i.data.teacherName) tSet.add(i.data.teacherName); 
            if(i.data.client) cSet.add(i.data.client);
            if(i.data.requestClient) rSet.add(i.data.requestClient); 
        });
        
        const tSelect = document.getElementById('teacherFilter');
        const cSelect = document.getElementById('clientFilter');
        const rSelect = document.getElementById('requestClientFilter'); 

        const currentT = tSelect.value;
        const currentC = cSelect.value;
        const currentR = rSelect.value;

        tSelect.innerHTML = `<option value="all">ì „ì²´</option>` + Array.from(tSet).map(t => `<option value="${t}" ${t===currentT?'selected':''}>${t}</option>`).join('');
        cSelect.innerHTML = `<option value="all">ì „ì²´</option>` + Array.from(cSet).map(c => `<option value="${c}" ${c===currentC?'selected':''}>${c}</option>`).join('');
        rSelect.innerHTML = `<option value="all">ì „ì²´</option>` + Array.from(rSet).map(r => `<option value="${r}" ${r===currentR?'selected':''}>${r}</option>`).join('');
        
        window.filterAssignments(); 
    });

    window.filterAssignments = () => {
        const t = document.getElementById('teacherFilter').value;
        const c = document.getElementById('clientFilter').value;
        const r = document.getElementById('requestClientFilter').value; 
        // ğŸ”¥ í™•ì¸ì—¬ë¶€ í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
        const s = document.getElementById('confirmFilter').value; 
        
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        const filtered = allAssignments.filter(item => {
            const data = item.data;
            if (t !== "all" && data.teacherName !== t) return false;
            if (c !== "all" && data.client !== c) return false;
            if (r !== "all" && data.requestClient !== r) return false;
            
            // ğŸ”¥ í™•ì¸ ì—¬ë¶€ í•„í„°ë§ ë¡œì§
            const isConfirmed = data.status === 'í™•ì¸ì™„ë£Œ';
            if (s === "confirmed" && !isConfirmed) return false;
            if (s === "pending" && isConfirmed) return false;

            if (startDate && endDate) {
                const dates = (data.date || "").split(', ');
                const isWithinRange = dates.some(d => d >= startDate && d <= endDate);
                if (!isWithinRange) return false;
            }
            return true;
        });
        
        renderList(filtered);
    }

    window.resetFilters = () => {
        document.getElementById('teacherFilter').value = 'all';
        document.getElementById('clientFilter').value = 'all';
        document.getElementById('requestClientFilter').value = 'all';
        document.getElementById('confirmFilter').value = 'all'; // ğŸ”¥ ì´ˆê¸°í™” ì¶”ê°€
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        window.filterAssignments();
    }
</script>
</body>
</html>