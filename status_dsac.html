<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë“€ë©”ì´ì»¤ - ë””ì‹¹ ë°°ì • í˜„í™©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; padding: 40px; margin: 0; padding-bottom: 100px; }
        .list-container { max-width: 1650px; margin: 0 auto; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f5; padding-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .logo { font-size: 24px; font-weight: 800; color: #0056b3; cursor: pointer; text-decoration: none; }
        h2 { color: #1a1a1a; margin: 0; font-size: 20px; }
        .header-btn-group { display: flex; gap: 10px; }
        .btn-header { padding: 10px 18px; border-radius: 8px; font-size: 14px; font-weight: 600; text-decoration: none; color: white; transition: background 0.2s; border: none; cursor: pointer; }
        .btn-tab { background-color: #f1f3f5; color: #495057; border: 1px solid #e9ecef; }
        .btn-tab.active { background-color: #28a745; color: white; border-color: #28a745; } /* ë””ì‹¹ ì „ìš© ì´ˆë¡ìƒ‰ í…Œë§ˆ */
        .btn-back { background-color: #6c757d; color: white; }
        
        .filter-bar { margin-bottom: 20px; display: flex; align-items: center; gap: 12px 20px; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; flex-wrap: wrap; }
        .filter-item { display: flex; align-items: center; gap: 8px; font-size: 13.5px; white-space: nowrap; }
        .filter-bar select, .filter-bar input { padding: 8px 10px; border-radius: 6px; border: 1px solid #ced4da; font-size: 13px; background-color: white; }
        
        .date-search-group { margin-left: auto; display: flex; align-items: center; gap: 5px; }
        .btn-search { background-color: #0056b3; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; margin-right: 8px; }
        .btn-reset { background-color: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; margin-right: 5px; }
        .btn-excel { background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        
        .table-responsive { width: 100%; overflow-x: auto; border-bottom: 1px solid #eee; position: relative; }
        table { width: 100%; min-width: 1100px; border-collapse: collapse; table-layout: fixed; border-top: 2px solid #28a745; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; font-size: 13px; vertical-align: middle; }
        th { background-color: #fafafa; color: #495057; font-weight: 700; font-size: 12px; text-align: center; }
        
        .col-no { width: 30px; text-align: center; }
        .col-date { width: 90px; text-align: center; }
        .col-user { width: 110px; text-align: center; }
        .col-info { width: 200px; } 
        .col-pay { width: 50px; text-align: right; }
        .col-total { width: 80px; text-align: right; }
        .col-note { width: 150px; }
        .col-chk { width: 80px; text-align: center; }
        .col-manage { width: 140px; text-align: center; }

        .row-class-finished, .row-class-finished td { background-color: #f3e5f5 !important; }
        .row-finished, .row-finished td { background-color: #fffde7 !important; }

        .btn-group { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
        .btn-group button { border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; padding: 5px 0; color: white; width: 45%; }
        .btn-finish { background-color: #28a745 !important; } 
        .btn-restore { background-color: #555e67 !important; } 
        .btn-confirm-wait { background:#ffeeba; color:#856404 !important; }
        .btn-confirm-ok { background:#d4edda; color:#155724 !important; }
        .btn-edit { background-color: #0056b3; }
        .btn-delete { background-color: #ff4d4f; }

        .chk-group { display: flex; flex-direction: column; gap: 5px; font-size: 11.5px; align-items: center; }
        .chk-group label { display: flex; align-items: center; cursor: pointer; justify-content: center; width: 100%; }
        .summary-bar { margin-top: 20px; background-color: #e8f5e9; border: 2px solid #28a745; border-radius: 12px; padding: 20px 30px; display: flex; justify-content: flex-end; align-items: center; gap: 40px; }
    </style>
</head>
<body>

<div class="list-container">
    <div class="header">
        <div style="display:flex; align-items:center; gap:10px;">
            <a href="admin.html" class="logo">EDUMAKER ADMIN</a>
            <h2>ğŸ“‹ ë””ì‹¹ ë°°ì • í˜„í™©</h2>
        </div>
        <div class="header-btn-group">
            <a href="status.html" class="btn-header btn-tab">ì „ì²´ë³´ê¸°</a>
            <a href="status_general.html" class="btn-header btn-tab">ì¼ë°˜ê°•ì˜</a>
            <a href="status_find.html" class="btn-header btn-tab">ì°¾í•™ì»¨</a>
            <a href="status_dsac.html" class="btn-header btn-tab active">ë””ì‹¹</a>
            <a href="admin.html" class="btn-header btn-back">ê°•ì˜ ë°°ì • í˜ì´ì§€</a>
        </div>
    </div>
    
    <div class="filter-bar">
        <div class="filter-item"><strong>ğŸ” ê°•ì‚¬ :</strong><select id="teacherFilter" onchange="filterAssignments()"></select></div>
        <div class="filter-item"><strong>ğŸ« ê°•ì˜ì²˜ :</strong><select id="clientFilter" onchange="filterAssignments()"></select></div>
        <div class="filter-item"><strong>ğŸ›ï¸ ì˜ë¢°ì²˜ :</strong><select id="requestClientFilter" onchange="filterAssignments()"></select></div>
        <div class="filter-item"><strong>ğŸ–ï¸ ì—­í•  :</strong><select id="roleFilter" onchange="filterAssignments()"></select></div>
        <div class="filter-item"><strong>ğŸ·ï¸ ì´ìš©ë£Œ :</strong><select id="servicePaidFilter" onchange="filterAssignments()">
            <option value="all">ì „ì²´</option><option value="paid">ì…ê¸ˆì™„ë£Œ</option><option value="unpaid">ë¯¸ì…ê¸ˆ</option>
        </select></div>
        <div class="filter-item"><strong>âœ… í™•ì¸ :</strong><select id="confirmFilter" onchange="filterAssignments()">
            <option value="all">ì „ì²´</option><option value="confirmed">í™•ì¸ì™„ë£Œ</option><option value="pending">í™•ì¸ëŒ€ê¸°</option>
        </select></div>
        <div class="date-search-group">
            <strong>ğŸ“… ê¸°ê°„ :</strong>
            <input type="date" id="startDate"> ~ <input type="date" id="endDate">
            <button class="btn-search" onclick="filterAssignments()">ì¡°íšŒ</button>
            <button class="btn-reset" onclick="resetFilters()">ì´ˆê¸°í™”</button>
            <button class="btn-excel" onclick="downloadExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <div class="table-responsive">
        <table id="actual-data-table">
            <thead>
                <tr>
                    <th class="col-no">No</th>
                    <th class="col-date">êµìœ¡ì¼ì/ì‹œê°„</th>
                    <th class="col-user">ì´ë¦„/ì „í™”ë²ˆí˜¸/ì´ë©”ì¼</th>
                    <th class="col-info">ê°•ì˜ì²˜(ì˜ë¢°ì²˜) / ê°•ì¢Œëª… / ì—­í• </th>
                    <th class="col-pay">ì‹œê°„/ì‹œê¸‰</th>
                    <th class="col-total">ì„œë¹„ìŠ¤/í•©ê³„</th>
                    <th class="col-note">ë¹„ê³ </th>
                    <th class="col-chk">ì •ì‚° ì²˜ë¦¬</th>
                    <th class="col-manage">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="admin-list-body">
                <tr><td colspan="9" style="text-align:center; padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>
    <div id="summary-container"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw", authDomain: "edumaker-teacher-d97ba.firebaseapp.com", projectId: "edumaker-teacher-d97ba", storageBucket: "edumaker-teacher-d97ba.firebasestorage.app", messagingSenderId: "532708143359", appId: "1:532708143359:web:89b9933da4c868127ddcca", measurementId: "G-JJ1TF77VBJ" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    let allAssignments = [];
    let currentlyShownData = [];
    let isInitialLoad = true;

    onSnapshot(query(collection(db, "assignments"), orderBy("createdAt", "desc"), limit(500)), (sn) => {
        let rawData = sn.docs.map(d => ({ id: d.id, data: d.data() })).filter(item => {
            const rc = item.data.requestClient || "";
            return rc.includes('ë””ì‹¹');
        });
        rawData.sort((a, b) => {
            const dateA = (a.data.date || "").split(', ')[0] || "0000-00-00";
            const dateB = (b.data.date || "").split(', ')[0] || "0000-00-00";
            return dateB.localeCompare(dateA);
        });
        allAssignments = rawData.map((item, index) => ({ ...item, virtualNo: rawData.length - index }));
        
        if (isInitialLoad) {
            updateFilterOptions();
            isInitialLoad = false;
        }
        filterAssignments(); 
    });

    function updateFilterOptions() {
        const tSet = new Set(); const cSet = new Set(); const rSet = new Set(); const roleSet = new Set();
        allAssignments.forEach(i => { 
            if(i.data.teacherName) tSet.add(i.data.teacherName); 
            if(i.data.client) cSet.add(i.data.client);
            if(i.data.requestClient) rSet.add(i.data.requestClient); 
            if(i.data.role) roleSet.add(i.data.role);
        });
        document.getElementById('teacherFilter').innerHTML = `<option value="all">ì „ì²´ ê°•ì‚¬</option>` + Array.from(tSet).sort().map(t => `<option value="${t}">${t}</option>`).join('');
        document.getElementById('clientFilter').innerHTML = `<option value="all">ì „ì²´ ê°•ì˜ì²˜</option>` + Array.from(cSet).sort().map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('requestClientFilter').innerHTML = `<option value="all">ì „ì²´ ì˜ë¢°ì²˜</option>` + Array.from(rSet).sort().map(r => `<option value="${r}">${r}</option>`).join('');
        document.getElementById('roleFilter').innerHTML = `<option value="all">ì „ì²´ ì—­í• </option>` + Array.from(roleSet).sort().map(role => `<option value="${role}">${role}</option>`).join('');
    }

    function getDayOfWeek(dateStr) {
        const week = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const day = new Date(dateStr).getDay();
        return isNaN(day) ? "" : `(${week[day]})`;
    }

    window.updatePayStatus = async function(docId, field, isChecked) { try { await updateDoc(doc(db, "assignments", docId), { [field]: isChecked }); } catch (error) {} }
    window.toggleFinishStatus = async function(docId, currentStatus) { if(!confirm(currentStatus ? "ë‹¤ì‹œ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; try { await updateDoc(doc(db, "assignments", docId), { isFinished: !currentStatus }); } catch (error) {} }
    window.deleteAssignment = async function(docId, subject, teacher) { if (!confirm(`[ì‚­ì œ í™•ì¸] ${teacher} ê°•ì‚¬ë‹˜ì˜ ${subject} ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return; try { await deleteDoc(doc(db, "assignments", docId)); } catch (error) {} }

    function renderList(dataList) {
        currentlyShownData = dataList;
        const listBody = document.getElementById('admin-list-body');
        const summaryCon = document.getElementById('summary-container');
        let html = "";
        let sumS = 0; let sumG = 0;

        dataList.forEach((item) => {
            const data = item.data;
            const totalPay = (Number(data.classHours || 0) * Number(data.hourlyRate || 0)) + Number(data.additionalCost || 0);
            sumS += Number(data.serviceFee || 0); sumG += totalPay;

            let schHtml = "";
            (data.date || "").split(', ').forEach((d, i) => {
                schHtml += `<div style="margin-bottom:3px;"><b style="color:#333;">${d}${getDayOfWeek(d)}</b><br><span style="color:#0056b3; font-size:11px;">${(data.time||"").split(', ')[i]||''}</span></div>`;
            });

            const req = (data.requestClient || "").trim();
            const lecCheckHtml = (req === "ì—ë“€ë©”ì´ì»¤") ? `<label><input type="checkbox" ${data.isPaidTeacher ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidTeacher', this.checked)"> ê°•ì‚¬ë£Œì™„ë£Œ</label>` : `<span style="color:#aaa; font-size:10px;">(ì˜ë¢°ì²˜ ì§€ê¸‰)</span>`;
            const serCheckHtml = Number(data.commissionRate || 0) > 0 ? `<label><input type="checkbox" ${data.isPaidService ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidService', this.checked)"> ì´ìš©ë£Œí™•ì¸</label>` : `<span style="color:#aaa; font-size:10px;">(ì´ìš©ë£Œ ì—†ìŒ)</span>`;

            const isConfirmed = data.status === 'í™•ì¸ì™„ë£Œ';

            html += `<tr class="${data.isFinished ? 'row-finished' : (data.isClassFinished ? 'row-class-finished' : '')}">
                <td class="col-no">${item.virtualNo}</td>
                <td class="col-date">${schHtml}</td>
                <td class="col-user">
                    <span style="font-weight:600; color:#333;">${data.teacherName}</span><br>
                    <span style="font-size:11.5px; color:#555;">${data.phone || '-'}</span><br>
                    <span style="font-size:11px; color:#888;">${data.teacherEmail}</span>
                </td>
                <td class="col-info">
                    <div style="font-weight:bold; color:#333; margin-bottom:4px;">
                        ${data.client} <span style="color:#6741d9; font-weight:600;">(${data.requestClient || '-'})</span>
                    </div>
                    <div style="font-size:12.5px; color:#555; margin-bottom:4px;">${data.subject}</div>
                    <div style="font-size:11.5px; color:#0056b3; font-weight:600;">ì—­í• : ${data.role || 'ê°•ì‚¬'}</div>
                </td>
                <td class="col-pay">${data.classHours}h<br><span style="font-size:11.5px; color:#666;">${Number(data.hourlyRate).toLocaleString()}</span></td>
                <td class="col-total"><span style="color:#0056b3;">${Number(data.serviceFee || 0).toLocaleString()}</span><br><b>${totalPay.toLocaleString()}</b></td>
                <td class="col-note"><div style="font-size:11.5px; color:#666; max-height:60px; overflow-y:auto;">${data.note || '-'}</div></td>
                <td class="col-chk"><div class="chk-group">${lecCheckHtml}${serCheckHtml}<label><input type="checkbox" ${data.isClassFinished ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isClassFinished', this.checked)"> ìˆ˜ì—…ì¢…ë£Œ</label></div></td>
                <td class="col-manage">
                    <div class="btn-group">
                        <button class="${isConfirmed ? 'btn-confirm-ok' : 'btn-confirm-wait'}">${isConfirmed ? 'í™•ì¸ë¨' : 'ëŒ€ê¸°ì¤‘'}</button>
                        <button class="${data.isFinished ? 'btn-restore' : 'btn-finish'}" onclick="toggleFinishStatus('${item.id}', ${data.isFinished})">${data.isFinished ? 'ë³µêµ¬' : 'ì™„ë£Œ'}</button>
                        <button class="btn-edit" onclick="window.open('edit.html?id=${item.id}')">ìˆ˜ì •</button>
                        <button class="btn-delete" onclick="deleteAssignment('${item.id}', '${data.subject}', '${data.teacherName}')">ì‚­ì œ</button>
                    </div>
                </td>
            </tr>`;
        });
        listBody.innerHTML = html || '<tr><td colspan="9" style="text-align:center; padding:40px;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        summaryCon.innerHTML = `<div class="summary-bar"><span>ì´ ${dataList.length}ê±´</span> | <span>ì´ìš©ë£Œ: ${sumS.toLocaleString()}ì›</span> | <span style="font-weight:bold; color:#28a745;">í•©ê³„: ${sumG.toLocaleString()}ì›</span></div>`;
    }

    window.filterAssignments = () => {
        const t = document.getElementById('teacherFilter').value; 
        const c = document.getElementById('clientFilter').value;
        const r = document.getElementById('requestClientFilter').value;
        const role = document.getElementById('roleFilter').value;
        const s = document.getElementById('confirmFilter').value; 
        const servicePaid = document.getElementById('servicePaidFilter').value;
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;

        const filtered = allAssignments.filter(item => {
            const data = item.data;
            if (t !== "all" && data.teacherName !== t) return false;
            if (c !== "all" && data.client !== c) return false;
            if (r !== "all" && data.requestClient !== r) return false;
            if (role !== "all" && data.role !== role) return false;
            if (s === "confirmed" && data.status !== 'í™•ì¸ì™„ë£Œ') return false;
            if (s === "pending" && data.status === 'í™•ì¸ì™„ë£Œ') return false;
            if (servicePaid === "paid" && !data.isPaidService) return false;
            if (servicePaid === "unpaid" && data.isPaidService) return false;
            if (start && end) {
                const dates = (data.date || "").split(', ');
                if (!dates.some(dt => dt >= start && dt <= end)) return false;
            }
            return true;
        });
        renderList(filtered);
    }

    window.downloadExcel = function() {
        if (currentlyShownData.length === 0) return;
        const excelData = currentlyShownData.map(item => {
            const d = item.data;
            return { "ë²ˆí˜¸": item.virtualNo, "êµìœ¡ì¼ì": d.date, "ê°•ì‚¬ëª…": d.teacherName, "ì „í™”ë²ˆí˜¸": d.phone || "-", "ì´ë©”ì¼": d.teacherEmail, "ì˜ë¢°ì²˜": d.requestClient || "-", "ê°•ì˜ì²˜": d.client, "ê°•ì¢Œëª…": d.subject, "ì—­í• ": d.role, "ì‹œê°„": d.classHours, "ì‹œê¸‰": d.hourlyRate, "ì„œë¹„ìŠ¤ì´ìš©ë£Œ": d.serviceFee, "í™•ì¸ìƒíƒœ": d.status };
        });
        const worksheet = XLSX.utils.json_to_sheet(excelData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "ë””ì‹¹í˜„í™©");
        XLSX.writeFile(workbook, `ì—ë“€ë©”ì´ì»¤_ë””ì‹¹í˜„í™©_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    window.resetFilters = () => { document.querySelectorAll('.filter-bar select').forEach(s => s.value = 'all'); document.querySelectorAll('.filter-bar input').forEach(i => i.value = ''); filterAssignments(); }
</script>
</body>
</html>