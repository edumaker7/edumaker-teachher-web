<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—ë“€ë©”ì´ì»¤ - ê°•ì˜ ë°°ì • ì‹œìŠ¤í…œ</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            // ê´€ë¦¬ìë‹˜ì˜ Public Key
            emailjs.init("0VVyqizaUqeIcG7FU");
        })();
    </script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; padding: 40px; margin: 0; }
        .admin-box { background: white; padding: 35px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); max-width: 550px; margin: 0 auto; }
        h2 { color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 15px; margin-bottom: 30px; text-align: center; }
        .input-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; font-size: 14px; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #0056b3; background-color: #f9fbff; }
        input[readonly] { background-color: #f1f3f5; cursor: not-allowed; }
        textarea { height: 80px; resize: none; font-family: inherit; }
        .btn-assign { width: 100%; padding: 16px; background-color: #0056b3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 17px; margin-top: 15px; transition: 0.3s; }
        .btn-assign:hover { background-color: #004494; transform: translateY(-1px); }
        .admin-footer-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn-status-link, .btn-list-link { flex: 1; padding: 14px; background-color: #f1f3f5; color: #495057; text-align: center; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; box-sizing: border-box; transition: 0.2s; border: 1px solid #e9ecef; }
        .btn-status-link:hover, .btn-list-link:hover { background-color: #e9ecef; color: #0056b3; border-color: #ced4da; }
    </style>
</head>
<body>

<div class="admin-box">
    <h2>EDUMAKER ë°°ì • ì‹œìŠ¤í…œ</h2>
    
    <div class="input-group">
        <label>ê°•ì‚¬ ì„±í•¨</label>
        <select id="teacherSelect" onchange="autoFillEmail()">
            <option value="">ê°•ì‚¬ë‹˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
    </div>

    <div class="input-group">
        <label>ê°•ì‚¬ ì´ë©”ì¼ (ìë™)</label>
        <input type="email" id="teacherEmail" readonly placeholder="ê°•ì‚¬ë‹˜ì„ ì„ íƒí•˜ë©´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤">
    </div>

    <div class="input-group">
        <label>ê°•ì˜ì²˜ (í•™êµ/ê¸°ê´€ëª…)</label>
        <input type="text" id="client" placeholder="ì˜ˆ: í¬í•­ì´ˆë“±í•™êµ">
    </div>

    <div class="input-group">
        <label>ê°•ì¢Œëª…</label>
        <input type="text" id="subject" placeholder="ì˜ˆ: ìƒì„±í˜• AI ìº í”„">
    </div>

    <div class="input-group">
        <label>ì—­í• </label>
        <select id="role">
            <option value="ì£¼ê°•ì‚¬">ì£¼ê°•ì‚¬</option>
            <option value="ë³´ì¡°ê°•ì‚¬">ë³´ì¡°ê°•ì‚¬</option>
            <option value="ì•ˆì „ìš”ì›">ì•ˆì „ìš”ì›</option>
        </select>
    </div>

    <div class="input-group">
        <label>êµìœ¡ ì¼ì</label>
        <input type="date" id="educationDate">
    </div>

    <div class="input-group">
        <label>êµìœ¡ ì‹œê°„ (ìƒì„¸)</label>
        <input type="text" id="educationTime" placeholder="ì˜ˆ: 13:00 ~ 15:00">
    </div>

    <div class="input-group">
        <label>ë¹„ê³  (ê¸°íƒ€ ì „ë‹¬ì‚¬í•­)</label>
        <textarea id="note" placeholder="ì¶”ê°€ ì „ë‹¬ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
    </div>

    <div class="input-group">
        <label>ì´ ê°•ì˜ ì‹œê°„</label>
        <input type="number" id="classHours" placeholder="ì˜ˆ: 4">
    </div>

    <div class="input-group">
        <label>ì‹œê°„ë‹¹ ê°•ì‚¬ë£Œ</label>
        <input type="number" id="hourlyRate" placeholder="ì˜ˆ: 50000">
    </div>

    <div class="input-group">
        <label>ì„œë¹„ìŠ¤ì´ìš©ë£Œ (%)</label>
        <input type="number" id="commissionRate" placeholder="ì˜ˆ: 10" value="0">
    </div>

    <button class="btn-assign" onclick="handleAssignment()">ê°•ì˜ ë°°ì •í•˜ê¸°</button>
    
    <div class="admin-footer-buttons">
        <a href="status.html" target="_blank" class="btn-status-link">ğŸ“‹ ë°°ì • í˜„í™© í™•ì¸</a>
        <a href="teacher_list.html" target="_blank" class="btn-list-link">ğŸ‘¥ ê°•ì‚¬ ëª©ë¡ ê´€ë¦¬</a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw",
        authDomain: "edumaker-teacher-d97ba.firebaseapp.com",
        projectId: "edumaker-teacher-d97ba",
        storageBucket: "edumaker-teacher-d97ba.firebasestorage.app",
        messagingSenderId: "532708143359",
        appId: "1:532708143359:web:89b9933da4c868127ddcca",
        measurementId: "G-JJ1TF77VBJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let teachersData = []; 

    async function fetchTeachers() {
        const teacherSelect = document.getElementById('teacherSelect');
        try {
            const querySnapshot = await getDocs(collection(db, "users"));
            querySnapshot.forEach((doc) => {
                const userData = doc.data();
                if(userData.name && userData.email) {
                    teachersData.push(userData);
                    const option = document.createElement('option');
                    option.value = userData.name;
                    option.text = userData.name;
                    teacherSelect.appendChild(option);
                }
            });
        } catch (error) {
            console.error("ê°•ì‚¬ ëª…ë‹¨ ë¡œë“œ ì˜¤ë¥˜:", error);
        }
    }
    fetchTeachers();

    window.autoFillEmail = function() {
        const selectedName = document.getElementById('teacherSelect').value;
        const emailInput = document.getElementById('teacherEmail');
        const teacher = teachersData.find(t => t.name === selectedName);
        emailInput.value = teacher ? teacher.email : "";
    }

    window.handleAssignment = async function() {
        const name = document.getElementById('teacherSelect').value;
        const email = document.getElementById('teacherEmail').value;
        const client = document.getElementById('client').value;
        const subject = document.getElementById('subject').value;
        const role = document.getElementById('role').value;
        const eduDate = document.getElementById('educationDate').value;
        const eduTime = document.getElementById('educationTime').value;
        const note = document.getElementById('note').value;
        const classHours = document.getElementById('classHours').value;
        const hourlyRate = document.getElementById('hourlyRate').value;
        const commissionRate = document.getElementById('commissionRate').value;

        if(!name || !client || !subject || !eduDate || !eduTime || !classHours || !hourlyRate) {
            alert("í•„ìˆ˜ í•„ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }

        try {
            const totalGrossPay = Number(classHours) * Number(hourlyRate);
            const calculatedServiceFee = Math.floor(totalGrossPay * (Number(commissionRate) / 100));

            // 1. Firebase Firestore ì €ì¥ (ê¸°ì¡´ í•„ë“œëª… ìœ ì§€)
            await addDoc(collection(db, "assignments"), {
                teacherName: name,
                teacherEmail: email,
                client: client,
                subject: subject,
                role: role,
                date: eduDate,
                time: eduTime,
                note: note,
                classHours: Number(classHours),
                hourlyRate: Number(hourlyRate),
                commissionRate: Number(commissionRate), 
                serviceFee: calculatedServiceFee,      
                status: "ë°°ì •ì™„ë£Œ",
                createdAt: new Date(),
                isPaidTeacher: false, 
                isPaidService: false  
            });

            // 2. ê°•ì‚¬ì—ê²Œ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ (EmailJS í…œí”Œë¦¿ í•„ë“œëª…ì— ë§ê²Œ ìˆ˜ì •ë¨)
            const templateParams = {
                teacherEmail: email,   // {{teacherEmail}}
                teacherName: name,    // {{teacherName}}
                client: client,       // {{client}}
                subject: subject,     // {{subject}}
                date: eduDate,        // {{date}}
                time: eduTime,        // {{time}}
                role: role            // {{role}}
            };

            emailjs.send('service_6f7u7om', 'template_05mv50b', templateParams)
                .then(function(response) {
                    console.log('ê°•ì‚¬ ì•Œë¦¼ ë©”ì¼ ë°œì†¡ ì„±ê³µ!', response.status, response.text);
                }, function(error) {
                    console.error('ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨...', error);
                });

            alert(name + " ê°•ì‚¬ë‹˜ê»˜ ê°•ì˜ ë°°ì • ë° ì•Œë¦¼ ë©”ì¼ ë°œì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            location.reload(); 
        } catch (error) {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
        }
    }
</script>
</body>
</html>
