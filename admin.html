<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë“€ë©”ì´ì»¤ - ê°•ì˜ ë°°ì • ì‹œìŠ¤í…œ</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; padding: 40px; margin: 0; }
        
        .admin-box { 
            background: white; padding: 35px; border-radius: 12px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); 
            max-width: 680px; width: 100%; margin: 0 auto; 
            box-sizing: border-box; 
        }
        
        h2 { color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 15px; margin-bottom: 30px; text-align: center; }
        .input-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; font-size: 14px; }
        .required { color: #d93025; margin-left: 3px; font-weight: bold; }
        
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .row-group { display: flex; gap: 15px; margin-bottom: 18px; flex-wrap: wrap; }
        .half-input { flex: 1; min-width: 250px; }
        
        .address-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .addr-search-group { flex: 7; display: flex; gap: 5px; min-width: 200px; }
        .addr-search-group input { flex: 1; background-color: #fff; }
        .btn-addr-search { width: 50px; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .btn-addr-search:hover { background-color: #5a6268; }
        
        /* ğŸ”¥ ê°•ì˜ì˜ë¢°ì²˜ ì…ë ¥ë€ ìŠ¤íƒ€ì¼ */
        #requestClient { flex: 3; min-width: 150px; }
        
        .role-wrapper { display: flex; gap: 10px; flex-wrap: wrap; }
        #roleSelect { flex: 1; min-width: 150px; }
        #roleInputDirect { flex: 1; display: none; min-width: 200px; }
        
        .schedule-row { 
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; 
            align-items: center; padding: 12px; 
            background-color: #f1f3f5; border-radius: 8px; border: 1px solid #e9ecef;
        }
        
        .schedule-row input[type="date"] { flex: 1; min-width: 140px; background: #fff; border: 1px solid #ced4da; } 

        .time-picker-group { display: flex; align-items: center; gap: 5px; flex: 2; justify-content: flex-end; flex-wrap: wrap; }

        /* ğŸ”¥ ì‹œê°„ ì„ íƒ UI ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        .time-set {
            display: flex; align-items: center; gap: 2px;
            background: #fff; border: 1px solid #ced4da; border-radius: 6px;
            padding: 0 5px; height: 45px;
        }

        .time-set select { 
            width: auto !important; /* 100% ë„ˆë¹„ í•´ì œ */
            border: none; background: transparent; padding: 0 2px; font-size: 14px; text-align: center; height: 100%; 
        }
        .time-set select:focus { outline: none; }

        .ampm-select { font-weight: bold; color: #0056b3; width: 55px !important; }
        .hour-select, .min-select { width: 45px !important; }
        
        .tilde { font-weight: bold; color: #888; margin: 0 2px; }
        
        .btn-remove-row { 
            background-color: #ff6b6b; color: white; border: none; 
            border-radius: 6px; width: 40px; height: 45px; 
            cursor: pointer; font-weight: bold; font-size: 20px; 
            display: flex; align-items: center; justify-content: center;
        }

        .btn-add-row { background-color: #51cf66; color: white; border: none; border-radius: 8px; padding: 12px 15px; cursor: pointer; font-weight: bold; font-size: 15px; width: 100%; margin-bottom: 10px; }
        .btn-assign { width: 100%; padding: 16px; background-color: #0056b3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 17px; margin-top: 15px; }
        
        .admin-footer-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn-status-link, .btn-list-link { flex: 1; min-width: 150px; padding: 14px; background-color: #f1f3f5; color: #495057; text-align: center; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; border: 1px solid #e9ecef; }

        @media (max-width: 600px) {
            body { padding: 20px; }
            .admin-box { padding: 25px 20px; }
            .schedule-row input[type="date"] { width: 100%; flex: 100%; margin-bottom: 5px; }
            .time-picker-group { width: 100%; justify-content: space-between; flex: 100%; }
            .time-set { flex: 1; justify-content: center; } 
            .btn-remove-row { width: 100%; margin-top: 5px; height: 35px; }
        }
    </style>
</head>
<body>

<div class="admin-box">
    <h2>EDUMAKER ë°°ì • ì‹œìŠ¤í…œ</h2>
    
    <div class="row-group">
        <div class="half-input">
            <label>ê°•ì‚¬ ì„±í•¨ <span class="required">*</span></label>
            <select id="teacherSelect">
                <option value="">ê°•ì‚¬ë‹˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
        </div>
        <div class="half-input">
            <label>ê°•ì‚¬ ì´ë©”ì¼ (ìë™ ì…ë ¥)</label>
            <input type="email" id="teacherEmail" readonly placeholder="ê°•ì‚¬ ì„ íƒ ì‹œ ìë™ ì…ë ¥">
        </div>
    </div>

    <div class="row-group">
        <div class="half-input">
            <label>ê°•ì˜ì²˜ <span class="required">*</span></label>
            <input type="text" id="client" placeholder="ì˜ˆ: í¬í•­ì´ˆë“±í•™êµ">
        </div>
        <div class="half-input">
            <label>ê°•ì¢Œëª…</label>
            <input type="text" id="subject" placeholder="ì˜ˆ: ìƒì„±í˜• AI ìº í”„">
        </div>
    </div>

    <div class="input-group">
        <label>ê°•ì˜ ì¥ì†Œ ë° ì˜ë¢°ì²˜ (ì£¼ì†Œ / ê°•ì˜ì˜ë¢°ì²˜)</label>
        <div class="address-row">
            <div class="addr-search-group">
                <input type="text" id="address" placeholder="ì£¼ì†Œ ì§ì ‘ ì…ë ¥ ë˜ëŠ” ê²€ìƒ‰">
                <button type="button" id="btnAddrSearch" class="btn-addr-search">ğŸ”</button>
            </div>
            <input type="text" id="requestClient" placeholder="ê°•ì˜ì˜ë¢°ì²˜ (ê´€ë¦¬ì ì „ìš©)">
        </div>
    </div>

    <div class="input-group">
        <label>ì—­í•  <span class="required">*</span></label>
        <div class="role-wrapper">
            <select id="roleSelect">
                <option value="">ì—­í• ì„ ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì£¼ê°•ì‚¬">ì£¼ê°•ì‚¬</option>
                <option value="ë³´ì¡°ê°•ì‚¬">ë³´ì¡°ê°•ì‚¬</option>
                <option value="ì•ˆì „ìš”ì›">ì•ˆì „ìš”ì›</option>
                <option value="direct">ì§ì ‘ ì…ë ¥ (ê¸°íƒ€)</option>
            </select>
            <input type="text" id="roleInputDirect" placeholder="ì—­í• ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”">
        </div>
    </div>

    <div class="input-group">
        <label>êµìœ¡ ì¼ì • <span class="required">*</span></label>
        <div id="scheduleContainer"></div>
        <button type="button" class="btn-add-row" id="addScheduleBtn">+ ì¼ì • ì¶”ê°€í•˜ê¸°</button>
    </div>

    <div class="row-group">
        <div class="half-input">
            <label>ì´ ê°•ì˜ ì‹œê°„</label>
            <input type="number" id="classHours" placeholder="ì˜ˆ: 4">
        </div>
        <div class="half-input">
            <label>ì‹œê°„ë‹¹ ê°•ì‚¬ë£Œ (ì›)</label>
            <input type="text" id="hourlyRate" placeholder="ì˜ˆ: 50,000">
        </div>
    </div>

    <div class="row-group">
        <div class="half-input">
            <label>ì¶”ê°€ ë¹„ìš© (êµí†µë¹„ ë“±)</label>
            <input type="text" id="additionalCost" placeholder="ì˜ˆ: 10,000">
        </div>
        <div class="half-input">
            <label>ì„œë¹„ìŠ¤ì´ìš©ë£Œ (%)</label>
            <input type="number" id="commissionRate" value="0">
        </div>
    </div>

    <div class="input-group">
        <label>ë¹„ê³  (ê¸°íƒ€ ì „ë‹¬ì‚¬í•­)</label>
        <textarea id="note" placeholder="íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”." style="height: 80px;"></textarea>
    </div>

    <button class="btn-assign" id="assignBtn">ê°•ì˜ ë°°ì •í•˜ê¸°</button>
    
    <div class="admin-footer-buttons">
        <a href="status.html" class="btn-status-link">ğŸ“‹ ë°°ì • í˜„í™© í™•ì¸</a>
        <a href="teacher_list.html" class="btn-list-link">ğŸ‘¥ ê°•ì‚¬ ëª©ë¡ ê´€ë¦¬</a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw",
        authDomain: "edumaker-teacher-d97ba.firebaseapp.com",
        projectId: "edumaker-teacher-d97ba",
        storageBucket: "edumaker-teacher-d97ba.firebasestorage.app",
        messagingSenderId: "532708143359",
        appId: "1:532708143359:web:89b9933da4c868127ddcca",
        measurementId: "G-JJ1TF77VBJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    emailjs.init("0VVyqizaUqeIcG7FU");

    function openDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                var roadAddr = data.roadAddress; 
                var jibunAddr = data.jibunAddress;
                var finalAddr = roadAddr !== '' ? roadAddr : jibunAddr;
                if(data.buildingName !== '') finalAddr += ' (' + data.buildingName + ')';
                document.getElementById("address").value = finalAddr;
                document.getElementById("requestClient").focus();
            }
        }).open();
    }

    document.getElementById('btnAddrSearch').addEventListener('click', openDaumPostcode);
    
    const roleSelect = document.getElementById('roleSelect');
    const roleInputDirect = document.getElementById('roleInputDirect');

    roleSelect.addEventListener('change', function() {
        if(this.value === 'direct') {
            roleInputDirect.style.display = 'block';
            roleInputDirect.focus(); 
        } else {
            roleInputDirect.style.display = 'none';
            roleInputDirect.value = '';
        }
    });

    function handleComma(e) {
        let value = e.target.value.replace(/[^0-9]/g, ''); 
        e.target.value = value ? Number(value).toLocaleString() : '';
    }
    document.getElementById('hourlyRate').addEventListener('input', handleComma);
    document.getElementById('additionalCost').addEventListener('input', handleComma);

    let teachersData = []; 
    async function fetchTeachers() {
        const teacherSelect = document.getElementById('teacherSelect');
        try {
            const querySnapshot = await getDocs(collection(db, "users"));
            querySnapshot.forEach((doc) => {
                const userData = doc.data();
                if (userData.email === "help@edumaker.kr") return;
                if(userData.name && userData.email) {
                    teachersData.push(userData);
                    const option = document.createElement('option');
                    option.value = userData.email; 
                    option.text = `${userData.name} (${userData.email})`; 
                    teacherSelect.appendChild(option);
                }
            });
        } catch (error) { console.error("ì˜¤ë¥˜:", error); }
    }
    fetchTeachers();

    document.getElementById('teacherSelect').addEventListener('change', () => {
        const selectedEmail = document.getElementById('teacherSelect').value;
        document.getElementById('teacherEmail').value = selectedEmail;
    });

    function createHourOptions() {
        let options = '';
        for(let i=1; i<=12; i++) {
            let val = i.toString().padStart(2, '0');
            options += `<option value="${val}">${val}</option>`;
        }
        return options;
    }
    function createMinuteOptions() {
        let options = '';
        for(let i=0; i<60; i+=5) { 
            let val = i.toString().padStart(2, '0');
            options += `<option value="${val}">${val}</option>`;
        }
        return options;
    }

    const scheduleContainer = document.getElementById('scheduleContainer');
    
    function addScheduleRow() {
        const row = document.createElement('div');
        row.className = 'schedule-row';
        const hourOpts = createHourOptions();
        const minOpts = createMinuteOptions();

        row.innerHTML = `
            <input type="date" class="input-date">
            <div class="time-picker-group">
                <div class="time-set">
                    <select class="ampm-start ampm-select">
                        <option value="ì˜¤ì „" selected>ì˜¤ì „</option>
                        <option value="ì˜¤í›„">ì˜¤í›„</option>
                    </select>
                    <select class="hour-start hour-select">${hourOpts}</select>
                    <span>:</span>
                    <select class="min-start min-select">${minOpts}</select>
                </div>
                <span class="tilde">~</span>
                <div class="time-set">
                    <select class="ampm-end ampm-select">
                        <option value="ì˜¤ì „" selected>ì˜¤ì „</option>
                        <option value="ì˜¤í›„">ì˜¤í›„</option>
                    </select>
                    <select class="hour-end hour-select">${hourOpts}</select>
                    <span>:</span>
                    <select class="min-end min-select">${minOpts}</select>
                </div>
            </div>
            <button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">-</button>
        `;
        scheduleContainer.appendChild(row);
    }
    addScheduleRow(); 
    document.getElementById('addScheduleBtn').addEventListener('click', addScheduleRow);


    document.getElementById('assignBtn').addEventListener('click', async () => {
        const selectedEmail = document.getElementById('teacherSelect').value;
        const teacherObj = teachersData.find(t => t.email === selectedEmail);
        const name = teacherObj ? teacherObj.name : "";
        const email = document.getElementById('teacherEmail').value;
        const client = document.getElementById('client').value;
        const subject = document.getElementById('subject').value;
        const address = document.getElementById('address').value;
        const requestClient = document.getElementById('requestClient').value; // ğŸ”¥ ê°•ì˜ì˜ë¢°ì²˜ ë³€ìˆ˜
        
        let role = document.getElementById('roleSelect').value;
        if (role === 'direct') {
            role = document.getElementById('roleInputDirect').value;
        }
        
        const rows = document.querySelectorAll('.schedule-row');
        let dateList = [];
        let timeList = [];
        rows.forEach(row => {
            const dateVal = row.querySelector('.input-date').value;
            const startAmpm = row.querySelector('.ampm-start').value;
            const startH = row.querySelector('.hour-start').value;
            const startM = row.querySelector('.min-start').value;
            const endAmpm = row.querySelector('.ampm-end').value;
            const endH = row.querySelector('.hour-end').value;
            const endM = row.querySelector('.min-end').value;

            if(dateVal) {
                dateList.push(dateVal);
                timeList.push(`${startAmpm} ${startH}:${startM} ~ ${endAmpm} ${endH}:${endM}`);
            }
        });

        const eduDate = dateList.join(', ');
        const eduTime = timeList.join(', ');
        const note = document.getElementById('note').value;
        
        const classHours = document.getElementById('classHours').value ? Number(document.getElementById('classHours').value) : 0;
        const rawHourlyRate = document.getElementById('hourlyRate').value.replace(/,/g, '');
        const hourlyRate = rawHourlyRate ? Number(rawHourlyRate) : 0;
        const rawAdditionalCost = document.getElementById('additionalCost').value.replace(/,/g, '');
        const additionalCost = rawAdditionalCost ? Number(rawAdditionalCost) : 0;
        const commissionRate = document.getElementById('commissionRate').value ? Number(document.getElementById('commissionRate').value) : 0;

        if (!name) { alert("ê°•ì‚¬ë‹˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
        if (!client) { alert("ê°•ì˜ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        if (!role) { alert("ì—­í• ì„ ì„ íƒ(í˜¹ì€ ì§ì ‘ì…ë ¥)í•´ì£¼ì„¸ìš”."); return; }
        if (dateList.length === 0) { alert("êµìœ¡ ì¼ì •ì„ ìµœì†Œ 1ê°œ ì´ìƒ ë“±ë¡í•´ì£¼ì„¸ìš”."); return; }

        try {
            const lectureFee = classHours * hourlyRate;
            const calculatedServiceFee = Math.floor(lectureFee * (commissionRate / 100));

            await addDoc(collection(db, "assignments"), {
                teacherName: name, 
                teacherEmail: email,
                client: client,
                address: address || "-",
                requestClient: requestClient || "", // ğŸ”¥ DBì—ëŠ” ì €ì¥ (ê´€ë¦¬ì í™•ì¸ìš©)
                subject: subject || "ë‚´ìš©ì—†ìŒ",
                role: role, 
                date: eduDate, 
                time: eduTime, 
                note: note,
                classHours: classHours,
                hourlyRate: hourlyRate,
                additionalCost: additionalCost,
                commissionRate: commissionRate, 
                serviceFee: calculatedServiceFee,       
                status: "ë°°ì •ì™„ë£Œ",
                createdAt: new Date(),
                isPaidTeacher: false, 
                isPaidService: false  
            });

            const templateParams = {
                teacherEmail: email,
                teacherName: name,
                client: client,
                address: address || "ì¥ì†Œ ì¶”í›„ê³µì§€",
                /* ğŸ”¥ ê°•ì‚¬ì—ê²Œ ë³´ë‚´ëŠ” ì´ë©”ì¼ í•­ëª©ì—ì„œ requestClient(ê°•ì˜ì˜ë¢°ì²˜) ì œì™¸ */
                subject: subject || "ê°•ì¢Œì •ë³´ ì—†ìŒ",
                date: eduDate, 
                time: eduTime || "ì‹œê°„ ì¶”í›„ê³µì§€",
                role: role, 
                additionalCost: additionalCost.toLocaleString() 
            };

            await emailjs.send('service_6f7u7om', 'template_05mv50b', templateParams);
            
            alert(name + " ê°•ì‚¬ë‹˜ ë°°ì • ë° ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ!");
            location.reload(); 
        } catch (error) {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
        }
    });
</script>
</body>
</html>