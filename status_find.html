<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë“€ë©”ì´ì»¤ - ì°¾í•™ì»¨ ë°°ì • í˜„í™©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; padding: 40px; margin: 0; padding-bottom: 100px; }
        .list-container { max-width: 1650px; margin: 0 auto; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f5; padding-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .logo { font-size: 24px; font-weight: 800; color: #0056b3; cursor: pointer; text-decoration: none; }
        h2 { color: #1a1a1a; margin: 0; font-size: 20px; }
        .header-btn-group { display: flex; gap: 10px; }
        .btn-header { padding: 10px 18px; border-radius: 8px; font-size: 14px; font-weight: 600; text-decoration: none; color: white; transition: background 0.2s; border: none; cursor: pointer; }
        .btn-tab { background-color: #f1f3f5; color: #495057; border: 1px solid #e9ecef; }
        .btn-tab.active { background-color: #6741d9; color: white; border-color: #6741d9; }
        .btn-back { background-color: #6c757d; color: white; }
        
        .filter-bar { margin-bottom: 20px; display: flex; align-items: center; gap: 12px 20px; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; flex-wrap: wrap; }
        .filter-item { display: flex; align-items: center; gap: 8px; font-size: 13.5px; white-space: nowrap; }
        .filter-bar select, .filter-bar input { padding: 8px 10px; border-radius: 6px; border: 1px solid #ced4da; font-size: 13px; background-color: white; }
        
        .date-search-group { margin-left: auto; display: flex; align-items: center; gap: 5px; }
        .btn-search { background-color: #0056b3; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; margin-right: 8px; }
        .btn-reset { background-color: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; margin-right: 5px; }
        .btn-excel { background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        
        .table-responsive { width: 100%; overflow-x: auto; border-bottom: 1px solid #eee; position: relative; }
        table { width: 100%; min-width: 1100px; border-collapse: collapse; table-layout: fixed; border-top: 2px solid #343a40; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; font-size: 13px; vertical-align: middle; }
        th { background-color: #fafafa; color: #495057; font-weight: 700; font-size: 12px; text-align: center; }
        
        .col-no { width: 20px; text-align: center; }
        .col-date { width: 90px; text-align: center; }
        .col-user { width: 115px; text-align: center; }
        .col-info { width: 175px; } 
        .col-pay { width: 80px; text-align: right; }
        .col-total { width: 80px; text-align: right; }
        .col-extra { width: 70px; text-align: right; }
        .col-note { width: 150px; }
        .col-chk { width: 70px; text-align: center; }
        .col-manage { width: 80px; text-align: center; }

        .row-class-finished, .row-class-finished td { background-color: #f3e5f5 !important; }
        .row-finished, .row-finished td { background-color: #fffde7 !important; }

        .note-container { 
            font-size: 12px; color: #444; max-height: 95px; overflow-y: auto; 
            text-align: left !important; line-height: 1.6; padding: 5px 8px;
            white-space: pre-line; word-break: break-all;
            background-color: transparent !important;
            border: 1px solid rgba(0,0,0,0.06); border-radius: 4px; display: block;
        }
        .note-container::-webkit-scrollbar { width: 4px; }
        .note-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 10px; }

        .btn-group { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; }
        .btn-group button { border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; padding: 5px 0; color: white; width: 48%; }
        .btn-finish { background-color: #28a745 !important; } 
        .btn-restore { background-color: #555e67 !important; } 
        .btn-confirm-wait { background:#ffeeba; color:#856404 !important; }
        .btn-confirm-ok { background:#d4edda; color:#155724 !important; }
        .btn-edit { background-color: #0056b3; }
        .btn-delete { background-color: #ff4d4f; }

        .chk-group { display: flex; flex-direction: column; gap: 4px; font-size: 11px; align-items: flex-start; padding-left: 5px; }
        .chk-group label { display: flex; align-items: center; cursor: pointer; gap: 4px; color: #444; }
        .summary-bar { margin-top: 20px; background-color: #f8f9fa; border: 2px solid #343a40; border-radius: 12px; padding: 20px 30px; display: flex; justify-content: flex-end; align-items: center; gap: 30px; }
        .purple-text { color: #6741d9; font-weight: 600; }
        .profit-text { color: #003399; font-weight: 800; }
        /* âœ… ì¶”ê°€ë¹„ìš© ìƒ‰ìƒ í†µì¼ */
        .add-cost-text { color: #444; font-size: 11px; font-weight: 600; }
    </style>
</head>
<body>

<div class="list-container">
    <div class="header">
        <div style="display:flex; align-items:center; gap:10px;"><a href="admin.html" class="logo">EDUMAKER ADMIN</a><h2>ğŸ“‹ ì°¾í•™ì»¨ ë°°ì • í˜„í™©</h2></div>
        <div class="header-btn-group">
            <a href="status.html" class="btn-header btn-tab">ì „ì²´ë³´ê¸°</a>
            <a href="status_general.html" class="btn-header btn-tab">ì¼ë°˜ê°•ì˜</a>
            <a href="status_find.html" class="btn-header btn-tab active">ì°¾í•™ì»¨</a>
            <a href="status_dsac.html" class="btn-header btn-tab">ë””ì‹¹</a>
            <a href="admin.html" class="btn-header btn-back">ê°•ì˜ ë°°ì • í˜ì´ì§€</a>
        </div>
    </div>
    
    <div class="filter-bar">
        <div class="filter-item"><strong>ğŸ” ê°•ì‚¬:</strong><select id="teacherFilter" onchange="filterAssignments()"></select></div>
        <div class="filter-item"><strong>ğŸ« ê°•ì˜ì²˜:</strong><select id="clientFilter" onchange="filterAssignments()"></select></div>
        <div class="filter-item"><strong>ğŸ›ï¸ ì˜ë¢°ì²˜:</strong><select id="requestClientFilter" onchange="filterAssignments()"></select></div>
        <div class="filter-item"><strong>ğŸ–ï¸ ì—­í• :</strong><select id="roleFilter" onchange="filterAssignments()"></select></div>
        <div class="filter-item"><strong>âœ… í™•ì¸:</strong><select id="confirmFilter" onchange="filterAssignments()">
            <option value="all">ì „ì²´</option><option value="confirmed">í™•ì¸ì™„ë£Œ</option><option value="pending">í™•ì¸ëŒ€ê¸°</option>
        </select></div>
        <div class="filter-item"><strong>ğŸ’° ê°•ì‚¬ë£Œ:</strong><select id="teacherPaidFilter" onchange="filterAssignments()">
            <option value="all">ì „ì²´</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option><option value="unpaid">ë¯¸ì§€ê¸‰</option><option value="direct">ì˜ë¢°ì²˜ ì§€ê¸‰</option>
        </select></div>
        <div class="filter-item"><strong>ğŸ·ï¸ ì´ìš©ë£Œ:</strong><select id="servicePaidFilter" onchange="filterAssignments()">
            <option value="all">ì „ì²´</option><option value="paid">í™•ì¸ì™„ë£Œ</option><option value="unpaid">ë¯¸í™•ì¸</option><option value="none">ì´ìš©ë£Œ ì—†ìŒ</option>
        </select></div>
        <div class="filter-item"><strong>ğŸš© ì™„ë£Œ:</strong><select id="finishedFilter" onchange="filterAssignments()">
            <option value="all">ì „ì²´</option><option value="finished">ìµœì¢…ì™„ë£Œ</option><option value="ongoing">ì§„í–‰ì¤‘</option>
        </select></div>
        <div class="date-search-group">
            <strong>ğŸ“… ê¸°ê°„:</strong>
            <input type="date" id="startDate"> ~ <input type="date" id="endDate">
            <button class="btn-search" onclick="filterAssignments()">ì¡°íšŒ</button>
            <button class="btn-reset" onclick="resetFilters()">ì´ˆê¸°í™”</button>
            <button class="btn-excel" onclick="downloadExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <div class="table-responsive">
        <table id="actual-data-table">
            <thead><tr>
                <th class="col-no">No</th>
                <th class="col-date">êµìœ¡ì¼ì/ì‹œê°„</th>
                <th class="col-user">ì´ë¦„/ì „í™”ë²ˆí˜¸/ì´ë©”ì¼</th>
                <th class="col-info">ê°•ì˜ì²˜(ì˜ë¢°ì²˜) / ê°•ì¢Œëª… / ì—­í• </th>
                <th class="col-pay">ì‹œê°„/ì‹œê¸‰/í•©ê³„</th>
                <th class="col-total">ì›ì‹œê°„/ì›ì‹œê¸‰/ì›ê°•ì‚¬ë£Œ</th>
                <th class="col-extra">ì¶”ê°€ë¹„ìš©/ì´ìš©ë£Œ</th>
                <th class="col-note">ë¹„ê³ </th>
                <th class="col-chk">ì •ì‚° ì²˜ë¦¬</th>
                <th class="col-manage">ê´€ë¦¬</th>
            </tr></thead>
            <tbody id="admin-list-body"><tr><td colspan="10" style="text-align:center; padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr></tbody>
        </table>
    </div>
    <div id="summary-container"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw", authDomain: "edumaker-teacher-d97ba.firebaseapp.com", projectId: "edumaker-teacher-d97ba", storageBucket: "edumaker-teacher-d97ba.firebasestorage.app", messagingSenderId: "532708143359", appId: "1:532708143359:web:89b9933da4c868127ddcca", measurementId: "G-JJ1TF77VBJ" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    let allAssignments = []; let currentlyShownData = []; let isInitialLoad = true;

    onSnapshot(query(collection(db, "assignments"), orderBy("createdAt", "desc"), limit(500)), (sn) => {
        let rawData = sn.docs.map(d => ({ id: d.id, data: d.data() })).filter(item => {
            const rc = item.data.requestClient || "";
            // âœ… 'ì°¾í•™ì»¨' í‚¤ì›Œë“œê°€ í¬í•¨ëœ ë°ì´í„°ë§Œ í•„í„°ë§
            return rc.includes('ì°¾í•™ì»¨');
        });
        rawData.sort((a, b) => ((b.data.date || "").split(', ')[0] || "0000-00-00").localeCompare((a.data.date || "").split(', ')[0] || "0000-00-00"));
        allAssignments = rawData.map((item, index) => ({ ...item, virtualNo: rawData.length - index }));
        if (isInitialLoad) { updateFilterOptions(); isInitialLoad = false; }
        filterAssignments(); 
    });

    function updateFilterOptions() {
        const tSet = new Set(); const cSet = new Set(); const rSet = new Set(); const roleSet = new Set();
        allAssignments.forEach(i => { if(i.data.teacherName) tSet.add(i.data.teacherName); if(i.data.client) cSet.add(i.data.client); if(i.data.requestClient) rSet.add(i.data.requestClient); if(i.data.role) roleSet.add(i.data.role); });
        document.getElementById('teacherFilter').innerHTML = `<option value="all">ì „ì²´ ê°•ì‚¬</option>` + Array.from(tSet).sort().map(t => `<option value="${t}">${t}</option>`).join('');
        document.getElementById('clientFilter').innerHTML = `<option value="all">ì „ì²´ ê°•ì˜ì²˜</option>` + Array.from(cSet).sort().map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('requestClientFilter').innerHTML = `<option value="all">ì „ì²´ ì˜ë¢°ì²˜</option>` + Array.from(rSet).sort().map(r => `<option value="${r}">${r}</option>`).join('');
        document.getElementById('roleFilter').innerHTML = `<option value="all">ì „ì²´ ì—­í• </option>` + Array.from(roleSet).sort().map(role => `<option value="${role}">${role}</option>`).join('');
    }

    function getDayOfWeek(dateStr) { const week = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ']; const day = new Date(dateStr).getDay(); return isNaN(day) ? "" : `(${week[day]})`; }
    window.updatePayStatus = async function(id, f, v) { await updateDoc(doc(db, "assignments", id), { [f]: v }); }
    window.toggleFinishStatus = async function(id, cur) { if(!confirm("ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; await updateDoc(doc(db, "assignments", id), { isFinished: !cur }); }
    window.deleteAssignment = async function(id, s, t) { if (!confirm(t + " ê°•ì‚¬ë‹˜ì˜ " + s + " ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; await deleteDoc(doc(db, "assignments", id)); }

    function renderList(dataList) {
        currentlyShownData = dataList; const listBody = document.getElementById('admin-list-body'); const summaryCon = document.getElementById('summary-container');
        let html = ""; let sumS = 0; let sumG = 0; let sumO = 0; let totalProfit = 0;

        dataList.forEach((item) => {
            const d = item.data; 
            const hrs = Number(d.classHours || 0); 
            const aHrs = d.adminHours !== undefined ? Number(d.adminHours) : 0; 
            const rate = Number(d.hourlyRate || 0); 
            const orig = Number(d.originalFee || 0); 
            const add = Number(d.additionalCost || 0);
            const fee = Number(d.serviceFee || 0);

            const totalPay = (hrs * rate) + add; 
            const totalOrig = (aHrs * orig); 
            
            sumS += fee; sumG += totalPay; sumO += totalOrig;
            if (orig > 0) totalProfit += (totalOrig - (hrs * rate));

            let schHtml = ""; (d.date || "").split(', ').forEach((dt, i) => { schHtml += `<div style="margin-bottom:3px;"><b>${dt}${getDayOfWeek(dt)}</b><br><span style="color:#0056b3; font-size:11px;">${(d.time||"").split(', ')[i]||''}</span></div>`; });
            const req = (d.requestClient || "").trim();
            const lecCheckHtml = (req === "ì—ë“€ë©”ì´ì»¤") ? `<label><input type="checkbox" ${d.isPaidTeacher ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidTeacher', this.checked)"> ê°•ì‚¬ë£Œì™„ë£Œ</label>` : `<span style="color:#aaa; font-size:10px;">(ì˜ë¢°ì²˜ ì§ì ‘ ì§€ê¸‰)</span>`;
            const serCheckHtml = (fee > 0) ? `<label><input type="checkbox" ${d.isPaidService ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidService', this.checked)"> ì´ìš©ë£Œí™•ì¸</label>` : `<span style="color:#aaa; font-size:10px;">(ì´ìš©ë£Œ ì—†ìŒ)</span>`;

            html += `
                <tr class="${d.isFinished ? 'row-finished' : (d.isClassFinished ? 'row-class-finished' : '')}">
                    <td class="col-no">${item.virtualNo}</td>
                    <td class="col-date">${schHtml}</td>
                    <td class="col-user"><b>${d.teacherName}</b><br><span style="font-size:11.5px; color:#555;">${d.phone || '-'}</span><br><span style="font-size:11px; color:#888;">${d.teacherEmail}</span></td>
                    <td class="col-info"><b>${d.client}</b> <span class="purple-text">(${d.requestClient || '-'})</span><br><span style="font-size:12.5px; color:#555;">${d.subject}</span><br><span style="font-size:11.5px; color:#0056b3; font-weight:600;">ì—­í• : ${d.role || 'ê°•ì‚¬'}</span></td>
                    <td class="col-pay">${hrs}h<br>${rate.toLocaleString()}<br><b>${totalPay.toLocaleString()}</b></td>
                    <td class="col-total">${aHrs}h<br>${orig.toLocaleString()}<br><span class="purple-text">${totalOrig.toLocaleString()}</span></td>
                    <td class="col-extra"><span class="add-cost-text">${add.toLocaleString()}</span><br><span style="color:#0056b3;">${fee.toLocaleString()}</span></td>
                    <td class="col-note"><div class="note-container">${d.note ? d.note.trim() : '-'}</div></td>
                    <td class="col-chk"><div class="chk-group">${lecCheckHtml}${serCheckHtml}<label><input type="checkbox" ${d.isClassFinished ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isClassFinished', this.checked)"> ìˆ˜ì—…ì¢…ë£Œ</label></div></td>
                    <td class="col-manage"><div class="btn-group"><button class="${d.status === 'í™•ì¸ì™„ë£Œ' ? 'btn-confirm-ok' : 'btn-confirm-wait'}">${d.status === 'í™•ì¸ì™„ë£Œ' ? 'í™•ì¸ë¨' : 'ëŒ€ê¸°ì¤‘'}</button><button class="${d.isFinished ? 'btn-restore' : 'btn-finish'}" onclick="toggleFinishStatus('${item.id}', ${d.isFinished})">${d.isFinished ? 'ë³µêµ¬' : 'ì™„ë£Œ'}</button><button class="btn-edit" onclick="window.open('edit.html?id=${item.id}')">ìˆ˜ì •</button><button class="btn-delete" onclick="deleteAssignment('${item.id}', '${d.subject}', '${d.teacherName}')">ì‚­ì œ</button></div></td>
                </tr>`;
        });
        listBody.innerHTML = html || '<tr><td colspan="10" style="text-align:center; padding:40px;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        summaryCon.innerHTML = `<div class="summary-bar"><span>ì´ <b>${currentlyShownData.length}</b>ê±´</span> | <span>ì´ìš©ë£Œ: <b>${sumS.toLocaleString()}</b>ì›</span> | <span class="purple-text">ì›ê°•ì‚¬ë£Œ í•©ê³„: <b>${sumO.toLocaleString()}</b>ì›</span> | <span style="font-weight:bold; color:#d93025;">í•©ê³„: <b>${sumG.toLocaleString()}</b>ì›</span> | <span class="profit-text">ìˆ˜ìµ: <b>${totalProfit.toLocaleString()}</b>ì›</span></div>`;
    }

    window.filterAssignments = () => {
        const t = document.getElementById('teacherFilter').value; const c = document.getElementById('clientFilter').value;
        const r = document.getElementById('requestClientFilter').value; const role = document.getElementById('roleFilter').value;
        const s = document.getElementById('confirmFilter').value; const teacherPaid = document.getElementById('teacherPaidFilter').value;
        const servicePaid = document.getElementById('servicePaidFilter').value; const finished = document.getElementById('finishedFilter').value;
        const start = document.getElementById('startDate').value; const end = document.getElementById('endDate').value;
        const filtered = allAssignments.filter(item => { const d = item.data; if (t !== "all" && d.teacherName !== t) return false; if (c !== "all" && d.client !== c) return false; if (r !== "all" && d.requestClient !== r) return false; if (role !== "all" && d.role !== role) return false; if (s === "confirmed" && d.status !== 'í™•ì¸ì™„ë£Œ') return false; if (s === "pending" && d.status === 'í™•ì¸ì™„ë£Œ') return false; if (teacherPaid === "paid" && !d.isPaidTeacher) return false; if (teacherPaid === "unpaid" && (d.isPaidTeacher || (d.requestClient || "").trim() !== "ì—ë“€ë©”ì´ì»¤")) return false; if (teacherPaid === "direct" && (d.requestClient || "").trim() === "ì—ë“€ë©”ì´ì»¤") return false; if (servicePaid === "paid" && !d.isPaidService) return false; if (servicePaid === "unpaid" && (d.isPaidService || Number(d.serviceFee || 0) <= 0)) return false; if (servicePaid === "none" && Number(d.serviceFee || 0) > 0) return false; if (finished === "finished" && !d.isFinished) return false; if (finished === "ongoing" && d.isFinished) return false; if (start && end) { const dates = (d.date || "").split(', '); if (!dates.some(dt => dt >= start && dt <= end)) return false; } return true; });
        renderList(filtered);
    }

    window.downloadExcel = function() {
        if (currentlyShownData.length === 0) return;
        const excelData = currentlyShownData.map(item => {
            const d = item.data; 
            const hrs = Number(d.classHours || 0);
            const aHrs = d.adminHours !== undefined ? Number(d.adminHours) : 0;
            const hourlyRate = Number(d.hourlyRate || 0);
            const addCost = Number(d.additionalCost || 0);
            const originalFee = Number(d.originalFee || 0);
            
            return { 
                "ë²ˆí˜¸": item.virtualNo, 
                "êµìœ¡ì¼ì": d.date, 
                "ê°•ì‚¬ëª…": d.teacherName, 
                "ì˜ë¢°ì²˜": d.requestClient || "-", 
                "ê°•ì˜ì²˜": d.client, 
                "ê°•ì¢Œëª…": d.subject, 
                "ì—­í• ": d.role, 
                "ì‹œê°„": hrs, 
                "ì¶”ê°€ë¹„ìš©": addCost, 
                "ì‹œê¸‰": hourlyRate, 
                "í•©ê³„": (hrs * hourlyRate) + addCost,
                "ì›ê°•ì˜ì‹œê°„": aHrs,
                "ì›ì‹œê¸‰": originalFee,
                "ì›ê°•ì‚¬ë£Œ": aHrs * originalFee,
                "ì„œë¹„ìŠ¤ ì´ìš©ë£Œ": d.serviceFee || 0,
                "ë¹„ê³ ": d.note || "", 
                "ì™„ë£Œì—¬ë¶€": d.isFinished ? "ì™„ë£Œ" : "ì§„í–‰ì¤‘" 
            };
        });
        const worksheet = XLSX.utils.json_to_sheet(excelData); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "ì°¾í•™ì»¨í˜„í™©");
        XLSX.writeFile(workbook, `ì—ë“€ë©”ì´ì»¤_ì°¾í•™ì»¨_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    window.resetFilters = () => { document.querySelectorAll('.filter-bar select').forEach(s => s.value = 'all'); document.querySelectorAll('.filter-bar input').forEach(i => i.value = ''); filterAssignments(); }
</script>
</body>
</html>